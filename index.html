<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Direction Hub • Grey Corner Fès</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ✅ PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --grey-dark:#2c2c2c;
      --grey-light:#f4f4f4;
      --gold:#c5a059;
      --status-ok:#10b981;
      --status-late:#f59e0b;
      --status-crit:#ef4444;
    }
    body{
      font-family:'Plus Jakarta Sans',sans-serif;
      background:var(--grey-light);
      color:var(--grey-dark);
      -webkit-tap-highlight-color:transparent;
    }
    .glass-card{
      background:#fff;
      border:1px solid #e5e7eb;
      box-shadow:0 4px 20px -5px rgba(0,0,0,.05);
    }
    .view-btn{color:var(--grey-dark);border:1px solid transparent;transition:.3s}
    .view-btn.active{background:var(--grey-dark);color:var(--gold);border-color:var(--gold)}
    .staff-card{border-left-width:5px;transition:transform .2s}
    .status-green{border-left-color:var(--status-ok)!important;background:#f0fdf4}
    .status-orange{border-left-color:var(--status-late)!important;background:#fffbeb}
    .status-red{border-left-color:var(--status-crit)!important;background:#fef2f2}
    .status-flash{
      border-left-color:var(--status-crit)!important;background:#fef2f2;
      animation:flash-red 1s infinite;
    }
    @keyframes flash-red{
      0%{box-shadow:inset 0 0 0px #ef4444}
      50%{box-shadow:inset 0 0 15px rgba(239,68,68,.2);border-left-width:8px}
      100%{box-shadow:inset 0 0 0px #ef4444}
    }
    .status-off{border-left-color:#94a3b8!important;background:#f8fafc;opacity:.6}

    .modal-active{display:flex!important;animation:slideUp .4s cubic-bezier(0,0,.2,1)}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

    /* ✅ PDF hidden area */
    #pdfArea{display:none;background:#fff;color:#111827}
    .pdfBox{border:1px solid #e5e7eb;border-radius:14px;padding:10px}
    .pdfKpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pdfKpi .t{font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:#6b7280;font-size:10px}
    .pdfKpi .v{font-weight:900;font-size:18px;margin-top:4px;color:#111827}
    .pdfTable{width:100%;border-collapse:collapse}
    .pdfTable th,.pdfTable td{border:1px solid #e5e7eb;padding:8px;font-size:11px}
    .pdfTable th{background:#f3f4f6;font-weight:900}

    /* ✅ Login UI */
    .inpt{
      width:100%;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:12px 12px;
      color:#111827;
      font-weight:800;
      font-size:12px;
      outline:none;
    }
    .inpt:focus{border-color:rgba(197,160,89,.55);box-shadow:0 0 0 3px rgba(197,160,89,.15)}
    .btn-login{
      width:100%;
      border-radius:16px;
      padding:12px 14px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      background:#0f172a;
      color:#fff;
      border:1px solid #0f172a;
    }
  </style>
</head>

<body class="antialiased pb-10">
  <div class="max-w-md mx-auto px-5 pt-8">

    <!-- ✅ LOGIN (GÉRANT ONLY) -->
    <div id="loginWrap" class="glass-card rounded-3xl p-5 mb-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-[10px] font-black uppercase tracking-[0.25em] text-slate-400">Accès sécurisé</div>
          <div class="text-xl font-black text-slate-900 mt-1">Connexion Gérant</div>
          <div class="text-[11px] font-bold text-[#c5a059] uppercase tracking-[0.3em] mt-1">Grey Corner Fès</div>
        </div>
        <div class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">RH</div>
      </div>

      <div class="mt-4 space-y-2">
        <input id="loginEmail" class="inpt" type="email" placeholder="Email" autocomplete="username" />
        <input id="loginPass" class="inpt" type="password" placeholder="Mot de passe" autocomplete="current-password" />
        <button id="btnLogin" class="btn-login">Se connecter</button>
        <div id="loginMsg" class="text-[11px] font-extrabold text-rose-600"></div>
      </div>
    </div>

    <!-- ✅ APP -->
    <div id="appWrap" class="hidden">
      <header class="flex justify-between items-start mb-6">
        <div>
          <h1 class="text-2xl font-black tracking-tighter text-slate-900 leading-none">RH SUPERVISION</h1>
          <p class="text-[10px] font-bold text-[#c5a059] uppercase tracking-[0.3em] mt-1">Grey Corner Fès</p>
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mt-2">
            Connecté : <span id="roleLabel" class="text-slate-900">—</span>
          </p>
          <p id="syncLine" class="text-[10px] font-extrabold text-slate-400 uppercase tracking-[0.2em] mt-2">Sync : —</p>
        </div>

        <div class="flex flex-col items-end gap-2">
          <button onclick="downloadPDF_Day()" class="px-4 py-2 rounded-full bg-slate-900 text-white text-[11px] font-extrabold shadow-sm">
            PDF JOUR
          </button>
          <button id="btnLogout" class="px-4 py-2 rounded-full bg-white text-slate-900 text-[11px] font-extrabold shadow-sm border border-slate-200">
            Déconnexion
          </button>
        </div>
      </header>

      <!-- ✅ CONTROLS (au-dessus) -->
      <div class="mb-4 space-y-4">
        <div class="flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100">
          <button onclick="switchMode('day', this)" class="view-btn active flex-1 py-3 text-[11px] font-extrabold rounded-xl uppercase tracking-wider">Jour</button>
          <button onclick="switchMode('report', this)" class="view-btn flex-1 py-3 text-[11px] font-extrabold rounded-xl uppercase tracking-wider">Bilan Mensuel</button>
        </div>

        <div class="relative">
          <input type="date" id="dashDate" class="w-full bg-transparent border-b-2 border-slate-200 py-2 font-bold text-slate-800 outline-none">
        </div>
      </div>

      <!-- ✅ (5) AFFICHAGE PERSONNEL AU DESSUS -->
      <div id="chartContainer" class="glass-card rounded-3xl p-6 mb-6 hidden">
        <div class="h-[180px] w-full">
          <canvas id="trendsChart"></canvas>
        </div>
      </div>

      <div id="dashBody" class="space-y-6"></div>

      <!-- ✅ (5) TOUTES LES FONCTIONNALITÉS AU DESSOUS -->
      <div class="mt-6 space-y-4">

        <!-- ✅ KPI global Congés/Repos (par poste + global) -->
        <div id="kpiOffBlock" class="glass-card rounded-3xl p-5 hidden"></div>

        <!-- ✅ (3) Congé par personne + choix du mois -->
        <div class="glass-card rounded-3xl p-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Congés / Repos</div>
              <div class="text-[12px] font-extrabold text-slate-700 mt-1">Par personne (choisir mois)</div>
            </div>
            <button id="btnToggleCongeTable" class="px-4 py-2 rounded-full bg-slate-900 text-white text-[11px] font-extrabold shadow-sm">
              Voir tableau
            </button>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2">
            <div>
              <div class="text-[10px] font-black text-slate-400 uppercase mb-1">Mois</div>
              <input id="congeMonth" type="month" class="w-full px-4 py-3 rounded-2xl border border-slate-200 font-extrabold text-slate-800 outline-none">
            </div>
            <div>
              <div class="text-[10px] font-black text-slate-400 uppercase mb-1">Poste</div>
              <select id="congePosteFilter" class="w-full px-4 py-3 rounded-2xl border border-slate-200 font-extrabold text-slate-800 outline-none">
                <option value="ALL">TOUS</option>
                <option value="SERVICE">SERVICE</option>
                <option value="BAR">BAR</option>
                <option value="CUISINE">CUISINE</option>
                <option value="CAISSE">CAISSE</option>
                <option value="MENAGE">MENAGE</option>
                <option value="ECONOMAT">ECONOMAT</option>
              </select>
            </div>
          </div>

          <!-- (2) "Supprimer congé par poste" = ici on filtre par poste (donc tu peux “enlever” l’affichage des congés d’un poste en choisissant un autre poste) -->
          <div class="text-[10px] text-slate-500 font-semibold leading-snug mt-2">
            Astuce: choisis un <b>poste</b> pour afficher/masquer les congés d’un poste (filtre).
          </div>

          <div id="congeTableWrap" class="hidden mt-4"></div>
        </div>

        <!-- ✅ PDF employé (Mois / Année) -->
        <div class="glass-card rounded-2xl p-4 flex flex-col gap-3">
          <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">PDF PAR EMPLOYÉ</div>

          <select id="empSelect" class="w-full px-4 py-3 rounded-2xl border border-slate-200 font-extrabold text-slate-800 outline-none"></select>

          <div class="grid grid-cols-2 gap-2">
            <button onclick="downloadPDF_EmployeeMonth()" class="px-4 py-3 rounded-2xl bg-[#c5a059] text-white font-extrabold text-[12px]">
              PDF MOIS
            </button>
            <button onclick="downloadPDF_EmployeeYear()" class="px-4 py-3 rounded-2xl bg-slate-900 text-white font-extrabold text-[12px]">
              PDF ANNÉE
            </button>
          </div>

          <div class="text-[10px] text-slate-500 font-semibold leading-snug">
            ✅ Les dates <b>exclues</b> (01/01/2026 → 31/01/2026) ne sont <b>jamais comptabilisées</b>.
          </div>
        </div>

        <!-- ✅ Gestion équipe -->
        <div class="glass-card rounded-2xl p-4 flex flex-col gap-3">
          <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">COLLABORATEURS</div>

          <div class="grid grid-cols-2 gap-2">
            <button id="btnOpenStaffAdmin" class="px-4 py-3 rounded-2xl bg-slate-900 text-white font-extrabold text-[12px]">
              GÉRER ÉQUIPE
            </button>
            <button id="btnExportEquipe" class="px-4 py-3 rounded-2xl bg-white text-slate-900 font-extrabold text-[12px] border border-slate-200">
              EXPORT JSON
            </button>
          </div>

          <div id="teamPermHint" class="text-[10px] text-slate-500 font-semibold leading-snug">
            Stocké dans Firebase: <b>settings/equipe</b>.
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ✅ MODAL Historique -->
  <div id="historyModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-md items-end" onclick="closeModal()">
    <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 shadow-2xl" onclick="event.stopPropagation()">
      <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-8"></div>
      <h2 id="modalTitle" class="text-xl font-black text-slate-900 uppercase mb-6 tracking-tight">Historique</h2>
      <div id="modalList" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
    </div>
  </div>

  <!-- ✅ MODAL Admin Équipe -->
  <div id="staffAdminModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-md items-end" onclick="closeStaffAdmin()">
    <div class="bg-white w-full rounded-t-[40px] p-6 pb-10 shadow-2xl" onclick="event.stopPropagation()">
      <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>

      <div class="flex items-start justify-between gap-3 mb-4">
        <div>
          <div class="text-[10px] font-black uppercase tracking-[0.25em] text-slate-400">Admin</div>
          <div class="text-xl font-black text-slate-900 mt-1">Gérer l’équipe</div>
          <div class="text-[11px] font-bold text-[#c5a059] uppercase tracking-[0.3em] mt-1">Grey Corner Fès</div>
        </div>
        <button class="px-3 py-2 rounded-full bg-slate-900 text-white text-[11px] font-extrabold" onclick="closeStaffAdmin()">Fermer</button>
      </div>

      <!-- ✅ AJOUT -->
      <div class="rounded-2xl border border-slate-100 p-4 bg-slate-50">
        <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 mb-3">Ajouter collaborateur</div>

        <div class="grid grid-cols-2 gap-2">
          <input id="addNom" class="inpt" placeholder="NOM (ex: ELALAMI)" />
          <input id="addPrenom" class="inpt" placeholder="Prénom (ex: HASSAN)" />
        </div>

        <select id="addPoste" class="w-full px-4 py-3 rounded-2xl border border-slate-200 font-extrabold text-slate-800 outline-none mt-2">
          <option value="SERVICE">SERVICE</option>
          <option value="BAR">BAR</option>
          <option value="CUISINE">CUISINE</option>
          <option value="CAISSE">CAISSE</option>
          <option value="MENAGE">MENAGE</option>
          <option value="ECONOMAT">ECONOMAT</option>
        </select>

        <button id="btnAddStaff" class="mt-3 w-full px-4 py-3 rounded-2xl bg-[#c5a059] text-white font-extrabold text-[12px]">
          AJOUTER
        </button>
        <div id="addMsg" class="mt-2 text-[11px] font-extrabold text-slate-500"></div>
      </div>

      <!-- ✅ SUPPRESSION PAR POSTE -->
      <div class="rounded-2xl border border-slate-100 p-4 mt-4">
        <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 mb-3">Supprimer collaborateur</div>

        <select id="delPosteSelect" class="w-full px-4 py-3 rounded-2xl border border-slate-200 font-extrabold text-slate-800 outline-none">
          <option value="">-- Choisir poste --</option>
          <option value="SERVICE">SERVICE</option>
          <option value="BAR">BAR</option>
          <option value="CUISINE">CUISINE</option>
          <option value="CAISSE">CAISSE</option>
          <option value="MENAGE">MENAGE</option>
          <option value="ECONOMAT">ECONOMAT</option>
        </select>

        <select id="delEmpSelect" class="w-full px-4 py-3 rounded-2xl border border-slate-200 font-extrabold text-slate-800 outline-none mt-2">
          <option value="">Choisir poste d'abord</option>
        </select>

        <button id="btnDeleteStaff" class="mt-3 w-full px-4 py-3 rounded-2xl bg-rose-600 text-white font-extrabold text-[12px]">
          SUPPRIMER
        </button>

        <div id="delAnyMsg" class="mt-2 text-[11px] font-extrabold text-slate-500"></div>
      </div>

      <!-- ✅ (1) Info Permission Denied -->
      <div class="mt-4 text-[10px] text-slate-500 font-semibold leading-snug">
        Si tu vois <b>PERMISSION_DENIED</b> à l’ajout/suppression, c’est tes <b>rules Firebase</b> qui bloquent l’écriture de <b>settings/equipe</b>.
        La solution est juste en bas du code (commentaire “RULES À AJOUTER”).
      </div>
    </div>
  </div>

  <!-- ✅ Hidden PDF container -->
  <div id="pdfArea" class="p-6">
    <div id="pdfHeader" class="mb-4"></div>
    <div id="pdfKpis" class="mb-4"></div>
    <div id="pdfContent"></div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyC5al_6xWbJC8S0FAvaEnRmx9BvYtGgnAM",
      authDomain: "grey-corner-presence.firebaseapp.com",
      databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "grey-corner-presence",
      storageBucket: "grey-corner-presence.firebasestorage.app",
      messagingSenderId: "730206093359",
      appId: "1:730206093359:web:59e3c145120807f29e46da",
      measurementId: "G-4HCKPGNED7"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // ===== UI refs =====
    const dateInput = document.getElementById('dashDate');
    const loginWrap = document.getElementById("loginWrap");
    const appWrap = document.getElementById("appWrap");
    const roleLabel = document.getElementById("roleLabel");
    const syncLine = document.getElementById("syncLine");

    let currentMode = 'day', myChart = null;
    let role = null; // must be "gerant"

    // ✅ listeners temps réel
    let activePresRef = null;
    let activePunchRef = null;

    // ✅ caches temps réel
    let presCache = {};
    let punchCache = {};

    // ✅ cache conge/mois sélectionné (table + KPI)
    let monthAggCache = null; // { monthKey:"YYYY-MM", congeById, reposById }

    /** =========================
     *  Équipe stockée en Firebase
     *  ========================= */
    const EQUIPE_PATH = "settings/equipe";

    // ===== Équipe fallback (GUETIBI retiré) =====
    const equipe = [
      {nom:'BOUCHNAK', prenom:'NAOUAL', poste:'CUISINE'},
      {nom:'ALAOUI', prenom:'LAZIZ', poste:'SERVICE'}, {nom:'BELQASSE', prenom:'KHAOULA', poste:'CUISINE'},
      {nom:'BENKHADA', prenom:'ABDESLAM', poste:'CAISSE'}, {nom:'BOURAHMA', prenom:'ANAS', poste:'CUISINE'},
      {nom:'CHKAIRI', prenom:'YOUSSEF', poste:'BAR'}, {nom:'ELKOBBI', prenom:'MOSTAFA', poste:'BAR'},
      {nom:'ELGORRAMY', prenom:'ANISSA', poste:'MENAGE'}, {nom:'ELGORRAMY', prenom:'SOUAD', poste:'MENAGE'},
      {nom:'ELMCHAOURI', prenom:'SOUAD', poste:'MENAGE'}, {nom:'ENNHAILI', prenom:'SOUMIA', poste:'ECONOMAT'},
      {nom:'FILALI', prenom:'ABDERAFI', poste:'BAR'},
      {nom:'HATTAF', prenom:'MOHAMED', poste:'SERVICE'}, {nom:'HIDARA', prenom:'YOUSSEF', poste:'SERVICE'},
      {nom:'IDRISSI', prenom:'SAAD', poste:'CUISINE'}, {nom:'KAFOUNI', prenom:'ZAKARIAE', poste:'SERVICE'},
      {nom:'KHALOUQ', prenom:'RACHID', poste:'BAR'}, {nom:'LEMSSIEH', prenom:'JAWAD', poste:'CUISINE'},
      {nom:'MAJDOUB', prenom:'JIHANE', poste:'CUISINE'},
      {nom:'MOHSINE', prenom:'YOUNESS', poste:'SERVICE'},
      {nom:'MOUJAHID', prenom:'IMANE', poste:'CUISINE'},
      {nom:'SALIL', prenom:'HOUDA', poste:'CAISSE'},
      {nom:'SBAI', prenom:'HAKIMA', poste:'MENAGE'},
      {nom:'ZAIR', prenom:'FATIMA', poste:'CUISINE'}
    ];

    // ✅ exceptions
    const haOnlyIds = new Set(["BOUCHNAK_NAOUAL", "ELMCHAOURI_SOUAD", "SBAI_HAKIMA"]);

    // ✅ EXCLUSION Janvier 2026
    const EXCL_START = "2026-01-01";
    const EXCL_END   = "2026-01-31";
    function isExcluded(dayISO){ return dayISO >= EXCL_START && dayISO <= EXCL_END; }

    // ✅ CAISSIERS: pas de repos d'office (tout off = congé)
    const CASHIER_NO_REPOS = new Set(["SALIL_HOUDA", "BENKHADA_ABDESLAM"]);
    function isCashierNoRepos(empId){ return CASHIER_NO_REPOS.has(empId); }

    // ✅ Dates sûres (UTC)
    function parseISO(iso){ const [y,m,d] = iso.split("-").map(Number); return {y,m,d}; }
    function toISO(y,m,d){ return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`; }
    function addDaysISO(iso, delta){
      const {y,m,d} = parseISO(iso);
      const t = Date.UTC(y, m-1, d) + delta*86400000;
      const dt = new Date(t);
      return toISO(dt.getUTCFullYear(), dt.getUTCMonth()+1, dt.getUTCDate());
    }

    // ✅ Week Monday
    function weekStartMondayISO(iso){
      const {y,m,d} = parseISO(iso);
      const dt = new Date(Date.UTC(y, m-1, d));
      const dow = dt.getUTCDay();
      const shift = (dow === 0) ? 6 : (dow - 1);
      return addDaysISO(iso, -shift);
    }
    function getWeekDatesISO(iso){
      const start = weekStartMondayISO(iso);
      return Array.from({length:7}, (_,i)=> addDaysISO(start, i));
    }

    // ✅ OFF => 1 repos/semaine sinon congé (sauf caissiers)
    function classifyOffDay(empId, dayISO, weekOffCount){
      if(isCashierNoRepos(empId)) return "CONGÉ";
      const weekKey = weekStartMondayISO(dayISO);
      weekOffCount[weekKey] ||= {};
      weekOffCount[weekKey][empId] ||= 0;
      if(weekOffCount[weekKey][empId] === 0){ weekOffCount[weekKey][empId] = 1; return "REPOS"; }
      weekOffCount[weekKey][empId] += 1;
      return "CONGÉ";
    }

    // ===== Helpers date (Casablanca) =====
    function todayISO(){
      return new Intl.DateTimeFormat('fr-CA',{
        timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'
      }).format(new Date());
    }
    function fmtFR(iso){
      if(!iso || !iso.includes("-")) return iso || "";
      const [y,m,d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }

    function getTimeDiff(a, p, id) {
      if(!a) return 0;
      if(!p) return 0;
      if(id && haOnlyIds.has(id)) return 0;
      const [ha,ma]=a.split(':').map(Number), [hp,mp]=p.split(':').map(Number);
      const d=(ha*60+ma)-(hp*60+mp);
      return d>0?d:0;
    }

    function getStatusClass(diff, isOff, hasArrived) {
      if (hasArrived) {
        if (diff <= 0) return 'status-green';
        if (diff > 0 && diff < 30) return 'status-orange';
        if (diff >= 30 && diff < 60) return 'status-red';
        if (diff >= 60) return 'status-flash';
      }
      if (isOff) return 'status-off';
      return '';
    }

    // ===== Équipe admin helpers =====
    function normName(s){
      return (s||"").trim().toUpperCase().replace(/\s+/g,' ').replace(/[’']/g,"'");
    }
    function makeEmpId(nom, prenom){ return `${normName(nom)}_${normName(prenom)}`.replace(/\s+/g,'_'); }

    async function loadEquipeFromDB(){
      const snap = await database.ref(EQUIPE_PATH).once("value");
      const arr = snap.val();
      if(Array.isArray(arr) && arr.length) return arr;
      return equipe; // fallback
    }

    async function saveEquipeToDB(list){
      // (1) PERMISSION_DENIED vient des rules => on catch et on affiche un message clair
      try{
        await database.ref(EQUIPE_PATH).set(list);
        document.getElementById("teamPermHint").innerHTML =
          `Stocké dans Firebase: <b>settings/equipe</b> ✅`;
        return true;
      }catch(e){
        const msg = (e && e.message) ? e.message : String(e||"");
        document.getElementById("teamPermHint").innerHTML =
          `<span class="text-rose-600 font-extrabold">⚠️ PERMISSION_DENIED</span> :
           Ajoute la règle Firebase pour autoriser le gérant à écrire <b>settings/equipe</b>.`;
        throw e;
      }
    }

    function openStaffAdmin(){
      const m = document.getElementById("staffAdminModal");
      m.classList.remove("hidden"); m.classList.add("modal-active");
    }
    function closeStaffAdmin(){
      const m = document.getElementById("staffAdminModal");
      m.classList.add("hidden"); m.classList.remove("modal-active");
    }

    function exportEquipeJSON(){
      const blob = new Blob([JSON.stringify(equipe, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `GC_EQUIPE_${todayISO()}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function fillEmpSelect(){
      const sel = document.getElementById("empSelect");
      const list = equipe.slice().sort((a,b)=>{
        const A=a.nom+"_"+a.prenom, B=b.nom+"_"+b.prenom;
        if(A==="BOUCHNAK_NAOUAL") return -1;
        if(B==="BOUCHNAK_NAOUAL") return 1;
        return (a.nom+a.prenom).localeCompare(b.nom+b.prenom);
      });
      sel.innerHTML = list.map(e=>{
        const id = e.nom+"_"+e.prenom;
        return `<option value="${id}">${e.nom} ${e.prenom} — ${e.poste}</option>`;
      }).join("");
    }

    function fillDelEmpSelectByPoste(poste){
      const sel = document.getElementById("delEmpSelect");
      if(!sel) return;

      if(!poste){ sel.innerHTML = `<option value="">Choisir poste d'abord</option>`; return; }

      const list = equipe
        .filter(e => e.poste === poste)
        .sort((a,b)=> (a.nom+a.prenom).localeCompare(b.nom+b.prenom));

      if(!list.length){ sel.innerHTML = `<option value="">Aucun collaborateur</option>`; return; }

      sel.innerHTML = list.map(e=>{
        const id = e.nom+"_"+e.prenom;
        return `<option value="${id}">${e.nom} ${e.prenom}</option>`;
      }).join("");
    }

    function refreshEquipeUI(){
      fillEmpSelect();
      const p = document.getElementById("delPosteSelect")?.value || "";
      fillDelEmpSelectByPoste(p);
      // recalcul congés si table ouverte
      const wrap = document.getElementById("congeTableWrap");
      if(wrap && !wrap.classList.contains("hidden")){
        computeAggForSelectedMonth().then(()=> renderCongeTable());
      }
      updateDashboard();
    }

    async function initStaffAdminUI(){
      document.getElementById("btnOpenStaffAdmin").onclick = () => openStaffAdmin();
      document.getElementById("btnExportEquipe").onclick = () => exportEquipeJSON();

      const posteSelect = document.getElementById("delPosteSelect");
      posteSelect.onchange = () => fillDelEmpSelectByPoste(posteSelect.value);
      fillDelEmpSelectByPoste("");

      document.getElementById("btnAddStaff").onclick = async () => {
        const addMsg = document.getElementById("addMsg");
        addMsg.textContent = "";

        const nom = normName(document.getElementById("addNom").value);
        const prenom = normName(document.getElementById("addPrenom").value);
        const poste = (document.getElementById("addPoste").value || "").trim().toUpperCase();

        if(!nom || !prenom || !poste){
          addMsg.textContent = "⚠️ Remplis NOM, Prénom et Poste.";
          return;
        }

        const id = makeEmpId(nom, prenom);
        if(equipe.some(e => (e.nom+"_"+e.prenom) === id)){
          addMsg.textContent = "⚠️ Déjà existant.";
          return;
        }

        addMsg.textContent = "Ajout…";
        try{
          equipe.push({ nom, prenom, poste });
          await saveEquipeToDB(equipe);
          addMsg.textContent = "✅ Ajouté.";
          document.getElementById("addNom").value = "";
          document.getElementById("addPrenom").value = "";
          refreshEquipeUI();
          closeStaffAdmin();
        }catch(e){
          // rollback local
          const idx = equipe.findIndex(x => (x.nom+"_"+x.prenom) === id);
          if(idx >= 0) equipe.splice(idx,1);
          addMsg.textContent = "⚠️ Erreur : " + (e?.message || "Permission denied");
        }
      };

      document.getElementById("btnDeleteStaff").onclick = async () => {
        const delMsg = document.getElementById("delAnyMsg");
        delMsg.textContent = "";

        const empId = document.getElementById("delEmpSelect").value;
        if(!empId){ delMsg.textContent = "⚠️ Choisis un collaborateur."; return; }

        const ok = confirm(`Confirmer suppression de ${empId} de l’équipe ?`);
        if(!ok) return;

        delMsg.textContent = "Suppression…";
        try{
          const idx = equipe.findIndex(e => (e.nom+"_"+e.prenom) === empId);
          if(idx >= 0){
            equipe.splice(idx, 1);
            await saveEquipeToDB(equipe);
          }
          delMsg.textContent = "✅ Supprimé.";
          refreshEquipeUI();
          closeStaffAdmin();
        }catch(e){
          delMsg.textContent = "⚠️ Erreur : " + (e?.message || "Permission denied");
        }
      };
    }

    // ===== Auth (GERANT only) =====
    async function fetchRole(uid){
      const s = await database.ref("users/"+uid).once("value");
      return s.val() || null;
    }

    function showLoginUI(msg){
      detachRealtime();
      role = null;
      appWrap.classList.add("hidden");
      loginWrap.classList.remove("hidden");
      document.getElementById("loginMsg").textContent = msg || "";
    }

    function showAppUI(){
      loginWrap.classList.add("hidden");
      appWrap.classList.remove("hidden");
      roleLabel.textContent = role || "—";
      syncLine.textContent = "Sync : en attente…";
    }

    document.getElementById("btnLogin").onclick = async () => {
      const email = (document.getElementById("loginEmail").value || "").trim();
      const pass  = (document.getElementById("loginPass").value || "").trim();
      document.getElementById("loginMsg").textContent = "";
      try{ await auth.signInWithEmailAndPassword(email, pass); }
      catch(e){ showLoginUI("Identifiants invalides."); }
    };

    document.getElementById("btnLogout").onclick = async () => {
      try{ await auth.signOut(); }catch(e){}
      location.reload();
    };

    auth.onAuthStateChanged(async (user) => {
      if(!user){ showLoginUI(""); return; }

      try{
        role = await fetchRole(user.uid);
        if(role !== "gerant"){
          await auth.signOut();
          showLoginUI("Accès refusé : compte non gérant.");
          return;
        }
      }catch(e){
        try{ await auth.signOut(); }catch(_){}
        showLoginUI("Erreur d'accès.");
        return;
      }

      showAppUI();
      bootDashboard();
    });

    // ===== Temps réel =====
    function detachRealtime(){
      try{
        if(activePresRef){ activePresRef.off(); activePresRef = null; }
        if(activePunchRef){ activePunchRef.off(); activePunchRef = null; }
      }catch(e){}
      presCache = {};
      punchCache = {};
    }

    function mergedDayData(){
      const out = JSON.parse(JSON.stringify(presCache || {}));
      const p = punchCache || {};
      Object.keys(p).forEach(empId => {
        out[empId] ||= {};
        const punchHA = p[empId]?.hA;
        if(punchHA){
          if(!out[empId].hA) out[empId].hA = punchHA;
          if(out[empId].off === true) out[empId].off = false;
        }
      });
      return out;
    }

    function setSyncOK(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const ss = String(now.getSeconds()).padStart(2,'0');
      syncLine.textContent = `Sync : temps réel ✅ (${hh}:${mm}:${ss})`;
    }
    function setSyncWaiting(){ syncLine.textContent = "Sync : connexion…"; }
    function setSyncError(){ syncLine.textContent = "Sync : erreur (réseau ?) ⚠️"; }

    function attachRealtimeForDate(dayISO){
      detachRealtime();
      setSyncWaiting();

      activePresRef = database.ref('presences/' + dayISO);
      activePresRef.on('value', (snap) => {
        presCache = snap.val() || {};
        if(currentMode === "day") renderDayView(mergedDayData());
        setSyncOK();
      }, () => setSyncError());

      activePunchRef = database.ref('punches/' + dayISO);
      activePunchRef.on('value', (snap) => {
        punchCache = snap.val() || {};
        if(currentMode === "day") renderDayView(mergedDayData());
        setSyncOK();
      }, () => setSyncError());
    }

    // ===== Mode switch =====
    function switchMode(mode, btn){
      currentMode = mode;
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('chartContainer').classList.toggle('hidden', mode !== 'report');

      if(mode !== "day"){
        document.getElementById("kpiOffBlock").classList.add("hidden");
        document.getElementById("congeTableWrap").classList.add("hidden");
        document.getElementById("btnToggleCongeTable").textContent = "Voir tableau";
      }

      updateDashboard();
    }

    // ===== Dates in month/year =====
    function getDatesInMonth(seedISO){
      const dates = [];
      const curr = new Date(seedISO);
      const m = curr.getMonth();
      const y = curr.getFullYear();
      const d = new Date(y, m, 1);
      while(d.getMonth() === m){
        dates.push(d.toISOString().split('T')[0]);
        d.setDate(d.getDate()+1);
      }
      return dates;
    }
    function getDatesInYear(seedISO){
      const curr = new Date(seedISO);
      const y = curr.getFullYear();
      const dates = [];
      const d = new Date(y, 0, 1);
      while(d.getFullYear() === y){
        dates.push(d.toISOString().split('T')[0]);
        d.setDate(d.getDate()+1);
      }
      return dates;
    }
    function getDatesInMonthKey(monthKey){ // "YYYY-MM"
      const seedISO = monthKey + "-01";
      return getDatesInMonth(seedISO);
    }

    // ===== (3) Calcul congés/repos pour le mois choisi =====
    async function computeAggForMonth(monthKey){
      const dates = getDatesInMonthKey(monthKey);
      const today = todayISO();

      // bornage: ignorer futurs
      const endISO = (monthKey === today.slice(0,7)) ? today : dates[dates.length-1];

      const presSnaps  = await Promise.all(dates.map(d => database.ref('presences/'+d).once('value')));
      const punchSnaps = await Promise.all(dates.map(d => database.ref('punches/'+d).once('value')));

      const congeById = {};
      const reposById = {};
      equipe.forEach(e=>{
        const id = e.nom+"_"+e.prenom;
        congeById[id] = 0;
        reposById[id] = 0;
      });

      const weekOffCount = {};

      dates.forEach((dISO, i)=>{
        if(dISO > endISO) return;
        if(isExcluded(dISO)) return;

        const pres = presSnaps[i].val() || {};
        const punches = punchSnaps[i].val() || {};
        const merged = JSON.parse(JSON.stringify(pres));

        Object.keys(punches).forEach(empId=>{
          merged[empId] ||= {};
          const punchHA = punches[empId]?.hA;
          if(punchHA){
            if(!merged[empId].hA) merged[empId].hA = punchHA;
            if(merged[empId].off === true) merged[empId].off = false;
          }
        });

        equipe.forEach(emp=>{
          const id = emp.nom+"_"+emp.prenom;
          const entry = merged[id] || null;

          if(!entry){ congeById[id] += 1; return; }

          if(entry.off){
            const typeOff = classifyOffDay(id, dISO, weekOffCount);
            if(typeOff === "REPOS") reposById[id] += 1;
            else congeById[id] += 1;
            return;
          }

          if(entry.hA) return;
          congeById[id] += 1;
        });
      });

      monthAggCache = { monthKey, congeById, reposById, endISO };
      return monthAggCache;
    }

    async function computeAggForSelectedMonth(){
      const m = document.getElementById("congeMonth").value; // "YYYY-MM"
      if(!m) return null;
      return computeAggForMonth(m);
    }

    function renderOffKpiBlockFromAgg(){
      const box = document.getElementById("kpiOffBlock");
      if(!monthAggCache){ box.classList.add("hidden"); box.innerHTML=""; return; }

      let totalConge = 0, totalRepos = 0;
      const perPoste = {};

      equipe.forEach(emp=>{
        perPoste[emp.poste] ||= { conge:0, repos:0 };
        const id = emp.nom+"_"+emp.prenom;
        const c = monthAggCache.congeById[id] || 0;
        const r = monthAggCache.reposById[id] || 0;

        totalConge += c; totalRepos += r;
        perPoste[emp.poste].conge += c;
        perPoste[emp.poste].repos += r;
      });

      const posteRows = Object.keys(perPoste).sort().map(poste=>{
        const v = perPoste[poste];
        return `
          <div class="flex items-center justify-between py-2 border-t border-slate-100">
            <div class="text-[11px] font-black uppercase text-slate-700">${poste}</div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded-full bg-slate-900 text-white text-[10px] font-black">C ${v.conge}</span>
              <span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-[10px] font-black border border-slate-200">R ${v.repos}</span>
            </div>
          </div>
        `;
      }).join("");

      box.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Congés / Repos pris</div>
            <div class="text-[12px] font-extrabold text-slate-700 mt-1">Mois : ${monthAggCache.monthKey} (jusqu’au ${fmtFR(monthAggCache.endISO)})</div>
          </div>
          <div class="text-right">
            <div class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Total</div>
            <div class="mt-1 flex items-center justify-end gap-2">
              <span class="px-3 py-1.5 rounded-full bg-[#c5a059] text-white text-[11px] font-black">C ${totalConge}</span>
              <span class="px-3 py-1.5 rounded-full bg-slate-900 text-white text-[11px] font-black">R ${totalRepos}</span>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 mb-2">Par poste</div>
          <div class="rounded-2xl bg-white border border-slate-100 overflow-hidden">
            <div class="px-4 py-2 flex justify-between items-center bg-slate-50 border-b border-slate-100">
              <span class="text-[10px] font-black uppercase text-slate-400">Poste</span>
              <span class="text-[10px] font-black uppercase text-slate-400">C / R</span>
            </div>
            <div class="px-4">${posteRows}</div>
          </div>

          <div class="mt-3 text-[10px] text-slate-500 font-semibold leading-snug">
            Règles: 1 repos/semaine (sauf caissiers: off = congé) • Jours futurs ignorés • Janvier 2026 exclu.
          </div>
        </div>
      `;
      box.classList.remove("hidden");
    }

    function renderCongeTable(){
      const wrap = document.getElementById("congeTableWrap");
      if(!monthAggCache){
        wrap.innerHTML = `<div class="text-[11px] font-extrabold text-slate-400">Aucune donnée.</div>`;
        return;
      }

      const posteFilter = document.getElementById("congePosteFilter").value || "ALL";

      const rows = equipe
        .filter(emp => posteFilter === "ALL" ? true : emp.poste === posteFilter)
        .map(emp=>{
          const id = emp.nom+"_"+emp.prenom;
          return {
            id,
            nom: emp.nom, prenom: emp.prenom, poste: emp.poste,
            conge: monthAggCache.congeById[id] || 0,
            repos: monthAggCache.reposById[id] || 0
          };
        })
        .sort((a,b)=> (b.conge - a.conge) || (b.repos - a.repos) || (a.nom+a.prenom).localeCompare(b.nom+b.prenom));

      const htmlRows = rows.map(r=>`
        <tr class="border-t border-slate-100">
          <td class="py-2 pr-2">
            <div class="text-[11px] font-black uppercase text-slate-800">${r.nom}</div>
            <div class="text-[10px] font-semibold text-slate-400">${r.prenom} • ${r.poste}</div>
          </td>
          <td class="py-2 text-right">
            <span class="px-2 py-1 rounded-full bg-[#c5a059] text-white text-[10px] font-black">C ${r.conge}</span>
          </td>
          <td class="py-2 text-right">
            <span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-[10px] font-black border border-slate-200">R ${r.repos}</span>
          </td>
        </tr>
      `).join("");

      wrap.innerHTML = `
        <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 mb-2">
          Mois: ${monthAggCache.monthKey} (jusqu’au ${fmtFR(monthAggCache.endISO)}) • Poste: ${posteFilter}
        </div>

        <div class="rounded-2xl border border-slate-100 overflow-hidden bg-white">
          <div class="px-4 py-2 bg-slate-50 border-b border-slate-100 flex justify-between">
            <span class="text-[10px] font-black uppercase text-slate-400">Employé</span>
            <span class="text-[10px] font-black uppercase text-slate-400">C / R</span>
          </div>
          <div class="px-4">
            <table class="w-full">
              <thead><tr class="hidden"><th>Employé</th><th>C</th><th>R</th></tr></thead>
              <tbody>${htmlRows}</tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ===== Main updater =====
    function updateDashboard(){
      if(role !== "gerant") return;

      const dayISO = dateInput.value;

      if(currentMode === "day"){
        attachRealtimeForDate(dayISO);
        renderDayView(mergedDayData());
        return;
      }

      detachRealtime();
      document.getElementById("kpiOffBlock").classList.add("hidden");
      renderReportView();
    }

    // ===== Day view =====
    function renderDayView(data){
      const container = document.getElementById('dashBody');
      const groups = {};
      equipe.forEach(e => (groups[e.poste] ||= []).push(e));

      let html = '';
      Object.keys(groups).forEach(poste => {
        html += `<div class="mb-8">
          <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 ml-1">${poste}</h3>
          <div class="grid grid-cols-2 gap-4">`;

        groups[poste].slice().sort((a,b)=>{
          const A = a.nom + '_' + a.prenom;
          const B = b.nom + '_' + b.prenom;
          if(A === "BOUCHNAK_NAOUAL") return -1;
          if(B === "BOUCHNAK_NAOUAL") return 1;
          return (a.nom+a.prenom).localeCompare(b.nom+b.prenom);
        }).forEach(emp => {
          const id = emp.nom + '_' + emp.prenom;
          const d = data[id] || {};

          const diff = getTimeDiff(d.hA, d.hP, id);
          const sClass = getStatusClass(diff, !!d.off, !!d.hA);

          let statusText = 'ATTENTE';
          let statusColor = 'text-slate-400';

          if(d.hA){
            if(d.hP){
              statusText = diff > 0 ? `${diff}m retard` : `À L'HEURE`;
              statusColor = diff > 0 ? 'text-rose-600' : 'text-emerald-600';
            }else{
              statusText = `OK`;
              statusColor = 'text-emerald-600';
            }
          } else if(d.off){
            statusText = 'REPOS';
            statusColor = 'text-slate-400';
          }

          html += `
            <button onclick="openHistory('${emp.nom}','${emp.prenom}')" class="staff-card ${sClass} glass-card p-4 rounded-2xl text-left flex flex-col justify-between h-28">
              <div>
                <p class="text-[11px] font-extrabold uppercase text-slate-800 truncate">${emp.nom}</p>
                <p class="text-[9px] font-medium text-slate-400">${emp.prenom}</p>
              </div>
              <p class="text-[10px] font-black ${statusColor}">${statusText}</p>
            </button>`;
        });

        html += `</div></div>`;
      });

      container.innerHTML = html;
    }

    // ===== Report view (mensuel) =====
    async function renderReportView(){
      const seedISO = dateInput.value;
      const dates = getDatesInMonth(seedISO);
      const today = todayISO();

      const stats = {};
      equipe.forEach(e => {
        const id = e.nom+'_'+e.prenom;
        stats[id] = { info: e, present: 0, lateMin: 0, repos: 0, conge: 0, excluded: 0 };
      });

      const weekOffCount = {};

      const presSnaps = await Promise.all(dates.map(d => database.ref('presences/'+d).once('value')));
      const punchSnaps = await Promise.all(dates.map(d => database.ref('punches/'+d).once('value')));

      const dailyLates = [], dailyPresence = [], labels = [];

      dates.forEach((dayISO, i) => {
        labels.push(dayISO.split('-')[2]);

        if(dayISO > today){ dailyLates.push(0); dailyPresence.push(0); return; }

        if(isExcluded(dayISO)){
          dailyLates.push(0); dailyPresence.push(0);
          Object.keys(stats).forEach(id => stats[id].excluded++);
          return;
        }

        const pres = presSnaps[i].val() || {};
        const punches = punchSnaps[i].val() || {};
        const merged = JSON.parse(JSON.stringify(pres));

        Object.keys(punches).forEach(empId=>{
          merged[empId] ||= {};
          const punchHA = punches[empId]?.hA;
          if(punchHA){
            if(!merged[empId].hA) merged[empId].hA = punchHA;
            if(merged[empId].off === true) merged[empId].off = false;
          }
        });

        let tL = 0, tP = 0;

        Object.keys(stats).forEach(id => {
          const e = merged[id] || null;

          if(!e){ stats[id].conge++; return; }

          if(e.off){
            const typeOff = classifyOffDay(id, dayISO, weekOffCount);
            if(typeOff === "REPOS") stats[id].repos++;
            else stats[id].conge++;
            return;
          }

          if(e.hA){
            const diff = getTimeDiff(e.hA, e.hP, id);
            stats[id].present++;
            stats[id].lateMin += diff;
            tL += diff; tP++;
            return;
          }

          stats[id].conge++;
        });

        dailyLates.push(tL);
        dailyPresence.push(tP);
      });

      renderChart(labels, dailyLates, dailyPresence);

      const lateList = Object.values(stats).filter(s => s.lateMin > 0).sort((a,b) => b.lateMin - a.lateMin);
      const goodList = Object.values(stats).filter(s => s.lateMin === 0 && s.present > 0).sort((a,b) => b.present - a.present);

      let html = '<div class="space-y-8">';

      html += `<div>
        <h3 class="text-[10px] font-black text-rose-500 uppercase tracking-[0.2em] mb-4">Top Retardataires</h3>`;
      if(lateList.length === 0){
        html += `<div class="glass-card p-5 rounded-2xl text-center text-slate-400 font-extrabold text-[12px]">Aucun retard enregistré</div>`;
      }else{
        lateList.slice(0, 6).forEach(s => {
          html += `<div class="glass-card p-5 rounded-2xl mb-3 flex justify-between items-center">
            <span class="text-xs font-extrabold uppercase">${s.info.nom}</span>
            <span class="text-rose-600 font-black">${s.lateMin}m</span>
          </div>`;
        });
      }
      html += `</div>`;

      html += `<div>
        <h3 class="text-[10px] font-black text-emerald-500 uppercase tracking-[0.2em] mb-4">Les plus exemplaires</h3>`;
      if(goodList.length === 0){
        html += `<div class="glass-card p-5 rounded-2xl text-center text-slate-400 font-extrabold text-[12px]">Aucune présence "OK" trouvée</div>`;
      }else{
        goodList.slice(0, 6).forEach(s => {
          html += `<div class="glass-card p-5 rounded-2xl mb-3 flex justify-between items-center">
            <span class="text-xs font-extrabold uppercase">${s.info.nom}</span>
            <span class="text-emerald-600 font-black">${s.present}j OK</span>
          </div>`;
        });
      }
      html += '</div></div>';

      document.getElementById('dashBody').innerHTML = html;
    }

    function renderChart(labels, lates, presences){
      const ctx = document.getElementById('trendsChart').getContext('2d');
      if(myChart) myChart.destroy();

      myChart = new Chart(ctx, {
        type:'line',
        data:{
          labels,
          datasets:[
            { label:"Retards (min)", data:lates, borderColor:'#c5a059', tension:.35, borderWidth:3, pointRadius:0, fill:true, backgroundColor:'rgba(197,160,89,0.08)' },
            { label:"Présences (nb)", data:presences, borderColor:'#0f172a', tension:.35, borderWidth:2, pointRadius:0, fill:false }
          ]
        },
        options:{
          maintainAspectRatio:false,
          plugins:{ legend:{display:false}, tooltip:{enabled:true} },
          scales:{ y:{display:false}, x:{grid:{display:false}, ticks:{font:{size:8}}} }
        }
      });
    }

    // ===== Historique modal =====
    async function openHistory(nom, prenom){
      const modal = document.getElementById('historyModal');
      document.getElementById('modalTitle').innerText = nom + " " + prenom;
      modal.classList.add('modal-active');

      const seed = dateInput.value;
      const dates = getDatesInMonth(seed);
      const today = todayISO();

      const presSnaps = await Promise.all(dates.map(dt => database.ref('presences/'+dt).once('value')));
      const punchSnaps = await Promise.all(dates.map(dt => database.ref('punches/'+dt).once('value')));

      const id = nom + '_' + prenom;

      const weekOffCount = {};
      const statusMap = {};

      dates.forEach((dayISO, idx) => {
        if(dayISO > today){ statusMap[dayISO] = { label:"À venir", cls:"text-slate-300" }; return; }
        if(isExcluded(dayISO)){ statusMap[dayISO] = { label:"Exclu", cls:"text-slate-400" }; return; }

        const pres = presSnaps[idx].val() || {};
        const punches = punchSnaps[idx].val() || {};
        const merged = JSON.parse(JSON.stringify(pres));

        Object.keys(punches).forEach(empId=>{
          merged[empId] ||= {};
          const punchHA = punches[empId]?.hA;
          if(punchHA){
            if(!merged[empId].hA) merged[empId].hA = punchHA;
            if(merged[empId].off === true) merged[empId].off = false;
          }
        });

        const entry = merged[id] || null;

        if(!entry){ statusMap[dayISO] = { label:"Congé", cls:"text-slate-500" }; return; }

        if(entry.hA){
          const diff = getTimeDiff(entry.hA, entry.hP, id);
          const label = entry.hP ? (diff>0 ? `${diff}m` : 'OK') : 'OK';
          const cls = (entry.hP && diff>0) ? 'text-rose-500' : 'text-emerald-500';
          statusMap[dayISO] = { label, cls };
          return;
        }

        if(entry.off){
          const typeOff = classifyOffDay(id, dayISO, weekOffCount);
          statusMap[dayISO] = {
            label: (typeOff === "REPOS") ? "Repos" : "Congé",
            cls: (typeOff === "REPOS") ? "text-slate-300" : "text-slate-500"
          };
          return;
        }

        statusMap[dayISO] = { label:"Congé", cls:"text-slate-500" };
      });

      const datesRev = dates.slice().reverse();
      let html = '';
      datesRev.forEach((dayISO) => {
        const st = statusMap[dayISO] || { label:"—", cls:"text-slate-400" };
        html += `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100">
          <span class="text-[10px] font-black text-slate-400 uppercase">${fmtFR(dayISO)}</span>
          <span class="text-[10px] font-black ${st.cls} uppercase">${st.label}</span>
        </div>`;
      });

      document.getElementById('modalList').innerHTML = html || '<p class="text-center text-slate-300 py-10">Aucune donnée</p>';
    }
    function closeModal(){ document.getElementById('historyModal').classList.remove('modal-active'); }

    // ===== PDF helpers =====
    function showPDF(el){ el.style.display="block"; }
    function hidePDF(el){ el.style.display="none"; }

    function pdfHeader(title, sub){
      const date = dateInput.value;
      return `
        <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;">
          <div>
            <div style="font-weight:900;letter-spacing:.12em;color:#b0892f;font-size:10px;text-transform:uppercase;">Fès — Maroc</div>
            <div style="font-weight:900;font-size:20px;letter-spacing:-.02em;">GREY CORNER</div>
            <div style="font-weight:800;color:#374151;font-size:12px;margin-top:2px;">${title}</div>
            <div style="font-weight:700;color:#6b7280;font-size:10px;margin-top:2px;">${sub || ""}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900;color:#111827;font-size:12px;">Date : ${date}</div>
            <div style="font-weight:700;color:#6b7280;font-size:10px;">(Exclus: 01/01/2026 → 31/01/2026)</div>
          </div>
        </div>
        <hr style="margin:14px 0;border:none;border-top:1px solid #e5e7eb;" />
      `;
    }
    function kpiBox(t, v){ return `<div class="pdfBox"><div class="t">${t}</div><div class="v">${v}</div></div>`; }

    // ✅ PDF JOUR (inchangé logique)
    async function downloadPDF_Day(){
      const dayISO = dateInput.value;

      const weekDates = getWeekDatesISO(dayISO);
      const presWeek = await Promise.all(weekDates.map(d => database.ref('presences/'+d).once('value')));
      const punchWeek = await Promise.all(weekDates.map(d => database.ref('punches/'+d).once('value')));

      const weekOffCount = {};
      const offTypeToday = {}; // empId -> "REPOS" | "CONGÉ"

      weekDates.forEach((dISO, i) => {
        if(isExcluded(dISO)) return;

        const presD = presWeek[i].val() || {};
        const punchD = punchWeek[i].val() || {};

        const mergedD = JSON.parse(JSON.stringify(presD));
        Object.keys(punchD).forEach(empId=>{
          mergedD[empId] ||= {};
          const punchHA = punchD[empId]?.hA;
          if(punchHA){
            if(!mergedD[empId].hA) mergedD[empId].hA = punchHA;
            if(mergedD[empId].off === true) mergedD[empId].off = false;
          }
        });

        equipe.forEach(emp=>{
          const id = emp.nom+"_"+emp.prenom;
          const e = mergedD[id] || null;
          if(e && e.off){
            const typeOff = classifyOffDay(id, dISO, weekOffCount);
            if(dISO === dayISO) offTypeToday[id] = typeOff;
          }
        });
      });

      const presSnap = await database.ref('presences/'+dayISO).once('value');
      const punchSnap = await database.ref('punches/'+dayISO).once('value');

      const pres = presSnap.val() || {};
      const punches = punchSnap.val() || {};

      const merged = JSON.parse(JSON.stringify(pres));
      Object.keys(punches).forEach(empId=>{
        merged[empId] ||= {};
        const punchHA = punches[empId]?.hA;
        if(punchHA){
          if(!merged[empId].hA) merged[empId].hA = punchHA;
          if(merged[empId].off === true) merged[empId].off = false;
        }
      });

      document.getElementById("pdfHeader").innerHTML = pdfHeader("Rapport Jour — Supervision", `Jour: ${fmtFR(dayISO)}`);

      let present=0, repos=0, attente=0;
      equipe.forEach(emp=>{
        const id = emp.nom+"_"+emp.prenom;
        const e = merged[id] || null;

        if(e && e.hA){
          present++;
        } else if(e && e.off){
          const t = offTypeToday[id] || (isCashierNoRepos(id) ? "CONGÉ" : "REPOS");
          if(t === "REPOS") repos++;
          else attente++;
        } else {
          attente++;
        }
      });

      document.getElementById("pdfKpis").innerHTML = `
        <div class="pdfKpi">
          ${kpiBox("Total", equipe.length)}
          ${kpiBox("Présents", present)}
          ${kpiBox("Repos", repos)}
          ${kpiBox("Attente", attente)}
        </div>
      `;

      const rows = equipe.slice().sort((a,b)=>{
        const A=a.nom+"_"+a.prenom, B=b.nom+"_"+b.prenom;
        if(A==="BOUCHNAK_NAOUAL") return -1;
        if(B==="BOUCHNAK_NAOUAL") return 1;
        return (a.nom+a.prenom).localeCompare(b.nom+b.prenom);
      }).map(emp=>{
        const id = emp.nom+"_"+emp.prenom;
        const e = merged[id] || null;

        let statut="ATTENTE", hp="", ha="", retard="";
        if(e){
          hp = e.hP || "";
          ha = e.hA || "";
          if(e.hA){
            statut="OK";
            if(e.hP){
              const diff = getTimeDiff(e.hA, e.hP, id);
              retard = diff>0 ? `+${diff}m` : "0";
              if(diff>0) statut="RETARD";
            }
          } else if(e.off){
            const t = offTypeToday[id] || (isCashierNoRepos(id) ? "CONGÉ" : "REPOS");
            statut = (t === "REPOS") ? "REPOS" : "CONGÉ";
          } else {
            statut="CONGÉ";
          }
        }else{
          statut="CONGÉ";
        }

        return `
          <tr>
            <td>${emp.nom} ${emp.prenom}</td>
            <td style="text-align:center;">${statut}</td>
            <td style="text-align:center;">${hp}</td>
            <td style="text-align:center;">${ha}</td>
            <td style="text-align:center;">${retard}</td>
          </tr>
        `;
      }).join("");

      document.getElementById("pdfContent").innerHTML = `
        <table class="pdfTable">
          <thead>
            <tr>
              <th style="text-align:left;">Employé</th>
              <th style="text-align:center;">Statut</th>
              <th style="text-align:center;">HP</th>
              <th style="text-align:center;">HA</th>
              <th style="text-align:center;">Retard</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const el = document.getElementById("pdfArea");
      showPDF(el);

      html2pdf().set({
        margin: 8,
        filename: `GC_RH_JOUR_${dayISO}.pdf`,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      }).from(el).save().then(()=>hidePDF(el)).catch(()=>hidePDF(el));
    }

    // ✅ (4) RÉINTÉGRÉ: PDF EMPLOYÉ MOIS (ta version complète)
    async function downloadPDF_EmployeeMonth(){
      const empId = document.getElementById("empSelect").value;
      const [nom, prenom] = empId.split("_");
      const seed = dateInput.value;
      const dates = getDatesInMonth(seed);
      const today = todayISO();

      const presSnaps = await Promise.all(dates.map(d => database.ref('presences/'+d).once('value')));
      const punchSnaps = await Promise.all(dates.map(d => database.ref('punches/'+d).once('value')));

      let present=0, repos=0, conge=0, lateMin=0, excluded=0, ignoredFuture=0;

      const weekOffCount = {};

      const rows = dates.map((dayISO, i)=>{
        if(dayISO > today){
          ignoredFuture++;
          return `<tr><td>${fmtFR(dayISO)}</td><td>À venir</td><td></td><td></td><td></td></tr>`;
        }
        if(isExcluded(dayISO)){
          excluded++;
          return `<tr><td>${fmtFR(dayISO)}</td><td>Exclu</td><td></td><td></td><td></td></tr>`;
        }

        const pres = presSnaps[i].val() || {};
        const punches = punchSnaps[i].val() || {};

        const merged = JSON.parse(JSON.stringify(pres));
        Object.keys(punches).forEach(eid=>{
          merged[eid] ||= {};
          const punchHA = punches[eid]?.hA;
          if(punchHA){
            if(!merged[eid].hA) merged[eid].hA = punchHA;
            if(merged[eid].off === true) merged[eid].off = false;
          }
        });

        const e = merged[empId] || null;

        if(!e){
          conge++;
          return `<tr><td>${fmtFR(dayISO)}</td><td>Congé</td><td></td><td></td><td></td></tr>`;
        }

        if(e.hA){
          present++;
          const diff = getTimeDiff(e.hA, e.hP, empId);
          lateMin += diff;
          const st = (e.hP && diff>0) ? "Retard" : "OK";
          const r = (e.hP) ? (diff>0 ? `+${diff}m` : "0") : "";
          return `<tr><td>${fmtFR(dayISO)}</td><td>${st}</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td>${r}</td></tr>`;
        }

        if(e.off){
          const typeOff = classifyOffDay(empId, dayISO, weekOffCount);
          if(typeOff === "REPOS"){
            repos++;
            return `<tr><td>${fmtFR(dayISO)}</td><td>Repos</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td></td></tr>`;
          }else{
            conge++;
            return `<tr><td>${fmtFR(dayISO)}</td><td>Congé</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td></td></tr>`;
          }
        }

        conge++;
        return `<tr><td>${fmtFR(dayISO)}</td><td>Congé</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td></td></tr>`;
      }).join("");

      document.getElementById("pdfHeader").innerHTML =
        pdfHeader(`Rapport Mensuel — ${nom} ${prenom}`, `Mois: ${seed.slice(0,7)}`);

      document.getElementById("pdfKpis").innerHTML = `
        <div class="pdfKpi">
          ${kpiBox("Présents", present)}
          ${kpiBox("Repos", repos)}
          ${kpiBox("Congés", conge)}
          ${kpiBox("Retard (min)", lateMin)}
        </div>
        <div style="margin-top:8px;color:#6b7280;font-size:10px;font-weight:700;">
          Exclu: ${excluded} jour(s) • Jours futurs ignorés: ${ignoredFuture}
        </div>
      `;

      document.getElementById("pdfContent").innerHTML = `
        <table class="pdfTable">
          <thead>
            <tr>
              <th style="text-align:left;">Date</th>
              <th style="text-align:center;">Statut</th>
              <th style="text-align:center;">HP</th>
              <th style="text-align:center;">HA</th>
              <th style="text-align:center;">Retard</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const el = document.getElementById("pdfArea");
      showPDF(el);

      const file = `GC_RH_MOIS_${nom}_${prenom}_${seed.slice(0,7)}.pdf`;

      html2pdf().set({
        margin: 8,
        filename: file,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      }).from(el).save().then(()=>hidePDF(el)).catch(()=>hidePDF(el));
    }

    // ✅ (4) RÉINTÉGRÉ: PDF EMPLOYÉ ANNÉE (ta version complète)
    async function downloadPDF_EmployeeYear(){
      const empId = document.getElementById("empSelect").value;
      const [nom, prenom] = empId.split("_");
      const seed = dateInput.value;
      const year = seed.slice(0,4);

      const dates = getDatesInYear(seed);
      const today = todayISO();

      const presSnaps = await Promise.all(dates.map(d => database.ref('presences/'+d).once('value')));
      const punchSnaps = await Promise.all(dates.map(d => database.ref('punches/'+d).once('value')));

      let present=0, repos=0, conge=0, lateMin=0, excluded=0, ignoredFuture=0;

      const weekOffCount = {};

      const rows = dates.map((dayISO, i)=>{
        if(dayISO > today){ ignoredFuture++; return ''; }
        if(isExcluded(dayISO)){ excluded++; return ''; }

        const pres = presSnaps[i].val() || {};
        const punches = punchSnaps[i].val() || {};

        const merged = JSON.parse(JSON.stringify(pres));
        Object.keys(punches).forEach(eid=>{
          merged[eid] ||= {};
          const punchHA = punches[eid]?.hA;
          if(punchHA){
            if(!merged[eid].hA) merged[eid].hA = punchHA;
            if(merged[eid].off === true) merged[eid].off = false;
          }
        });

        const e = merged[empId] || null;

        if(!e){
          conge++;
          return `<tr><td>${fmtFR(dayISO)}</td><td>Congé</td><td></td><td></td><td></td></tr>`;
        }

        if(e.hA){
          present++;
          const diff = getTimeDiff(e.hA, e.hP, empId);
          lateMin += diff;
          const st = (e.hP && diff>0) ? "Retard" : "OK";
          const r = (e.hP) ? (diff>0 ? `+${diff}m` : "0") : "";
          return `<tr><td>${fmtFR(dayISO)}</td><td>${st}</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td>${r}</td></tr>`;
        }

        if(e.off){
          const typeOff = classifyOffDay(empId, dayISO, weekOffCount);
          if(typeOff === "REPOS"){
            repos++;
            return `<tr><td>${fmtFR(dayISO)}</td><td>Repos</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td></td></tr>`;
          }else{
            conge++;
            return `<tr><td>${fmtFR(dayISO)}</td><td>Congé</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td></td></tr>`;
          }
        }

        conge++;
        return `<tr><td>${fmtFR(dayISO)}</td><td>Congé</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td></td></tr>`;
      }).join("");

      document.getElementById("pdfHeader").innerHTML =
        pdfHeader(`Rapport Annuel — ${nom} ${prenom}`, `Année: ${year}`);

      document.getElementById("pdfKpis").innerHTML = `
        <div class="pdfKpi">
          ${kpiBox("Présents", present)}
          ${kpiBox("Repos", repos)}
          ${kpiBox("Congés", conge)}
          ${kpiBox("Retard (min)", lateMin)}
        </div>
        <div style="margin-top:8px;color:#6b7280;font-size:10px;font-weight:700;">
          Exclu (01/01/2026 → 31/01/2026): ${excluded} jour(s) ignorés • Jours futurs ignorés: ${ignoredFuture}
        </div>
      `;

      document.getElementById("pdfContent").innerHTML = `
        <table class="pdfTable">
          <thead>
            <tr>
              <th style="text-align:left;">Date</th>
              <th style="text-align:center;">Statut</th>
              <th style="text-align:center;">HP</th>
              <th style="text-align:center;">HA</th>
              <th style="text-align:center;">Retard</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const el = document.getElementById("pdfArea");
      showPDF(el);

      const file = `GC_RH_ANNEE_${nom}_${prenom}_${year}.pdf`;

      html2pdf().set({
        margin: 8,
        filename: file,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      }).from(el).save().then(()=>hidePDF(el)).catch(()=>hidePDF(el));
    }

    // ===== Boot =====
    async function bootDashboard(){
      dateInput.value = todayISO();
      dateInput.addEventListener('change', updateDashboard);

      // default month selector = month of selected date
      document.getElementById("congeMonth").value = dateInput.value.slice(0,7);

      // load team from DB
      try{
        const list = await loadEquipeFromDB();
        equipe.splice(0, equipe.length, ...list);
      }catch(e){}

      fillEmpSelect();
      await initStaffAdminUI();

      // congé controls
      document.getElementById("congePosteFilter").onchange = () => {
        const wrap = document.getElementById("congeTableWrap");
        if(wrap && !wrap.classList.contains("hidden")) renderCongeTable();
      };

      document.getElementById("congeMonth").onchange = async () => {
        const wrap = document.getElementById("congeTableWrap");
        if(wrap && !wrap.classList.contains("hidden")){
          await computeAggForSelectedMonth();
          renderOffKpiBlockFromAgg();
          renderCongeTable();
        }
      };

      document.getElementById("btnToggleCongeTable").onclick = async () => {
        const wrap = document.getElementById("congeTableWrap");
        const btn = document.getElementById("btnToggleCongeTable");
        const willShow = wrap.classList.contains("hidden");
        wrap.classList.toggle("hidden");
        if(willShow){
          btn.textContent = "Masquer tableau";
          await computeAggForSelectedMonth();
          renderOffKpiBlockFromAgg();
          renderCongeTable();
        }else{
          btn.textContent = "Voir tableau";
        }
      };

      // show KPI block when day mode and month selected computed (optional)
      // only shown when table opened OR you can uncomment next lines to always show:
      // await computeAggForSelectedMonth();
      // renderOffKpiBlockFromAgg();

      updateDashboard();
    }

    /* =========================
       (1) RULES À AJOUTER (Firebase RTDB)
       =========================
       Dans Firebase > Realtime Database > Rules, ajoute cette branche :

       "settings": {
         ".read": "auth != null && root.child('users').child(auth.uid).val() == 'gerant'",
         ".write":"auth != null && root.child('users').child(auth.uid).val() == 'gerant'",
         "equipe": { ".validate": "newData.isArray()" }
       }

       => Sans ça, l’ajout/suppression donne PERMISSION_DENIED.
    */
  </script>
</body>
</html>