<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Direction Hub • Grey Corner Fès</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --grey-dark: #2c2c2c;
      --grey-light: #f4f4f4;
      --gold: #c5a059;
      --gold-light: #e2cfab;
      --status-ok: #10b981;    /* Vert */
      --status-late: #f59e0b;  /* Orange */
      --status-crit: #ef4444;  /* Rouge */
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--grey-light);
      color: var(--grey-dark);
      -webkit-tap-highlight-color: transparent;
    }

    /* Thème Cozy Grey & Gold */
    .glass-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05);
    }

    .view-btn {
      color: var(--grey-dark);
      border: 1px solid transparent;
      transition: all 0.3s ease;
    }
    .view-btn.active {
      background: var(--grey-dark);
      color: var(--gold);
      border-color: var(--gold);
    }

    /* Logique de couleurs demandée */
    .staff-card { border-left-width: 5px; transition: transform 0.2s; }

    .status-green { border-left-color: var(--status-ok) !important; background: #f0fdf4; }
    .status-orange { border-left-color: var(--status-late) !important; background: #fffbeb; }
    .status-red { border-left-color: var(--status-crit) !important; background: #fef2f2; }

    /* Rouge qui flash (+1h) */
    .status-flash {
      border-left-color: var(--status-crit) !important;
      background: #fef2f2;
      animation: flash-red 1s infinite;
    }
    @keyframes flash-red {
      0% { box-shadow: inset 0 0 0px #ef4444; }
      50% { box-shadow: inset 0 0 15px rgba(239, 68, 68, 0.2); border-left-width: 8px; }
      100% { box-shadow: inset 0 0 0px #ef4444; }
    }

    .status-off { border-left-color: #94a3b8 !important; background: #f8fafc; opacity: 0.6; }

    /* Modal Style */
    .modal-active { display: flex !important; animation: slideUp 0.4s cubic-bezier(0, 0, 0.2, 1); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  </style>
</head>

<body class="antialiased pb-10">
  <div class="max-w-md mx-auto px-5 pt-8">

    <header class="flex justify-between items-start mb-10">
      <div>
        <h1 class="text-2xl font-black tracking-tighter text-slate-900 leading-none">RH SUPERVISION</h1>
        <p class="text-[10px] font-bold text-[#c5a059] uppercase tracking-[0.3em] mt-1">Grey Corner Fès</p>
      </div>
      <button onclick="toggleExclusion()" class="relative">
        <div id="excludeIcon" class="w-12 h-12 rounded-full flex items-center justify-center bg-white border border-slate-200 shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </button>
    </header>

    <div class="mb-8 space-y-4">
      <div class="flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100">
        <button onclick="switchMode('day', this)" class="view-btn active flex-1 py-3 text-[11px] font-extrabold rounded-xl uppercase tracking-wider">Jour</button>
        <button onclick="switchMode('report', this)" class="view-btn flex-1 py-3 text-[11px] font-extrabold rounded-xl uppercase tracking-wider">Bilan Mensuel</button>
      </div>

      <div class="relative">
        <input type="date" id="dashDate" class="w-full bg-transparent border-b-2 border-slate-200 py-2 font-bold text-slate-800 outline-none">
      </div>
    </div>

    <div id="chartContainer" class="glass-card rounded-3xl p-6 mb-8 hidden">
      <div class="h-[180px] w-full">
        <canvas id="trendsChart"></canvas>
      </div>
    </div>

    <div id="dashBody" class="space-y-6"></div>
  </div>

  <div id="historyModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-md items-end" onclick="closeModal()">
    <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 shadow-2xl" onclick="event.stopPropagation()">
      <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-8"></div>
      <h2 id="modalTitle" class="text-xl font-black text-slate-900 uppercase mb-6 tracking-tight">Historique</h2>
      <div id="modalList" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const dateInput = document.getElementById('dashDate');
    let currentMode = 'day', myChart = null;

    // ✅ listener unique (évite accumulation)
    let activeDayListenerRef = null;

    // ✅ Chef cuisine ajouté (et on la met en premier dans la liste)
    const equipe = [
      {nom:'BOUCHNAK', prenom:'NAOUAL', poste:'CUISINE'}, // ✅ NEW Chef cuisine (hA-only possible)

      {nom: 'ALAOUI', prenom: 'LAZIZ', poste: 'SERVICE'}, {nom: 'BELQASSE', prenom: 'KHAOULA', poste: 'CUISINE'},
      {nom: 'BENKHADA', prenom: 'ABDESLAM', poste: 'CAISSE'}, {nom: 'BOURAHMA', prenom: 'ANAS', poste: 'CUISINE'},
      {nom: 'CHKAIRI', prenom: 'YOUSSEF', poste: 'BAR'}, {nom: 'ELKOBBI', prenom: 'MOSTAFA', poste: 'BAR'},
      {nom: 'ELGORRAMY', prenom: 'ANISSA', poste: 'MENAGE'}, {nom: 'ELGORRAMY', prenom: 'SOUAD', poste: 'MENAGE'},
      {nom: 'ELMCHAOURI', prenom: 'SOUAD', poste: 'MENAGE'}, {nom: 'ENNHAILI', prenom: 'SOUMIA', poste: 'ECONOMAT'},
      {nom: 'FILALI', prenom: 'ABDERAFI', poste: 'BAR'}, {nom: 'GUETIBI', prenom: 'AMINE', poste: 'SERVICE'},
      {nom: 'HATTAF', prenom: 'MOHAMED', poste: 'SERVICE'}, {nom: 'HIDARA', prenom: 'YOUSSEF', poste: 'SERVICE'},
      {nom: 'IDRISSI', prenom: 'SAAD', poste: 'CUISINE'}, {nom: 'KAFOUNI', prenom: 'ZAKARIAE', poste: 'SERVICE'},
      {nom: 'KHALOUQ', prenom: 'RACHID', poste: 'BAR'}, {nom: 'LEMSSIEH', prenom: 'JAWAD', poste: 'CUISINE'},
      {nom: 'MAJDOUB', prenom: 'JIHANE', poste: 'CUISINE'}, {nom: 'MOHSINE', prenom: 'YOUNESS', poste: 'SERVICE'},
      {nom: 'MOUJAHID', prenom: 'IMANE', poste: 'CUISINE'}, {nom: 'SALIL', prenom: 'HOUDA', poste: 'CAISSE'},
      {nom: 'SBAI', prenom: 'HAKIMA', poste: 'MENAGE'}, {nom: 'ZAIR', prenom: 'FATIMA', poste: 'CUISINE'}
    ];

    // ✅ IDs hA-only (pas pénalisé si hP vide)
    const haOnlyIds = new Set(["BOUCHNAK_NAOUAL"]);

    dateInput.value = new Intl.DateTimeFormat('fr-CA', {timeZone: 'Africa/Casablanca', year:'numeric', month:'2-digit', day:'2-digit'}).format(new Date());
    dateInput.addEventListener('change', updateDashboard);
    updateDashboard();

    function switchMode(mode, btn) {
      currentMode = mode;
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('chartContainer').classList.toggle('hidden', mode !== 'report');
      updateDashboard();
    }

    function toggleExclusion() { database.ref('presences/' + dateInput.value + '/disabled').transaction(v => !v); }

    function updateDashboard() {
      // ✅ stop ancien listener
      if(activeDayListenerRef){
        activeDayListenerRef.off();
        activeDayListenerRef = null;
      }

      // En mode report: pas besoin de listener live
      if(currentMode === 'report'){
        renderReportView();
        return;
      }

      // Mode day: listener live
      activeDayListenerRef = database.ref('presences/' + dateInput.value);
      activeDayListenerRef.on('value', (snap) => {
        const data = snap.val() || {};
        updateExcludeUI(data.disabled);
        renderDayView(data);
      });
    }

    function updateExcludeUI(ex) {
      const icon = document.getElementById('excludeIcon');
      icon.style.backgroundColor = ex ? '#ef4444' : '#ffffff';
      icon.style.color = ex ? '#ffffff' : '#2c2c2c';
    }

    function getStatusClass(diff, isOff, hasArrived) {
      if (isOff) return 'status-off';
      if (!hasArrived) return '';
      if (diff <= 0) return 'status-green'; // À l'heure
      if (diff > 0 && diff < 30) return 'status-orange'; // Retard < 30mn
      if (diff >= 30 && diff < 60) return 'status-red'; // Retard > 30mn
      if (diff >= 60) return 'status-flash'; // Retard > 1h (Flash)
      return '';
    }

    function renderDayView(data) {
      const container = document.getElementById('dashBody');
      const groups = {};
      equipe.forEach(e => (groups[e.poste] ||= []).push(e));

      let html = '';
      Object.keys(groups).forEach(poste => {
        html += `<div class="mb-8"><h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 ml-1">${poste}</h3><div class="grid grid-cols-2 gap-4">`;

        // ✅ tri: Chef cuisine 1ère dans CUISINE
        groups[poste]
          .slice()
          .sort((a,b)=>{
            const A = a.nom + '_' + a.prenom;
            const B = b.nom + '_' + b.prenom;
            if(A === "BOUCHNAK_NAOUAL") return -1;
            if(B === "BOUCHNAK_NAOUAL") return 1;
            return (a.nom+a.prenom).localeCompare(b.nom+b.prenom);
          })
          .forEach(emp => {
            const id = emp.nom + '_' + emp.prenom;
            const d = data[id] || {};

            // ✅ Chef hA-only: retard calculé uniquement si hP existe
            const diff = getTimeDiff(d.hA, d.hP, id);
            const sClass = getStatusClass(diff, d.off, !!d.hA);

            let statusText = 'ATTENTE';
            let statusColor = 'text-slate-400';

            if(d.off){
              statusText = 'REPOS';
              statusColor = 'text-slate-400';
            } else if(d.hA){
              if(d.hP){ // si planning dispo
                statusText = diff > 0 ? `${diff}m retard` : `À L'HEURE`;
                statusColor = diff > 0 ? 'text-rose-600' : 'text-emerald-600';
              }else{
                // hA-only ou planning non défini: considérer OK (pas de retard)
                statusText = `OK`;
                statusColor = 'text-emerald-600';
              }
            }

            html += `
              <button onclick="openHistory('${emp.nom}','${emp.prenom}')" class="staff-card ${sClass} glass-card p-4 rounded-2xl text-left flex flex-col justify-between h-28 ${data.disabled?'opacity-20':''}">
                <div>
                  <p class="text-[11px] font-extrabold uppercase text-slate-800 truncate">${emp.nom}</p>
                  <p class="text-[9px] font-medium text-slate-400">${emp.prenom}</p>
                </div>
                <p class="text-[10px] font-black ${statusColor}">
                  ${statusText}
                </p>
              </button>`;
          });

        html += `</div></div>`;
      });

      container.innerHTML = html;
    }

    async function renderReportView() {
      const dates = getDatesInMonth();
      const stats = {};
      equipe.forEach(e => stats[e.nom+'_'+e.prenom] = { info: e, present: 0, late: 0 });

      const snaps = await Promise.all(dates.map(d => database.ref('presences/'+d).once('value')));

      const dailyLates = [], dailyPresence = [], labels = [];

      snaps.forEach((s, i) => {
        const dData = s.val() || {};
        let tL = 0, tP = 0;

        if (!dData.disabled) {
          Object.keys(stats).forEach(id => {
            const e = dData[id];

            if(e && e.hA && !e.off) {
              // ✅ Chef hA-only: late=0 si hP absent
              const diff = getTimeDiff(e.hA, e.hP, id);
              stats[id].present++;
              stats[id].late += diff;
              tL += diff; tP++;
            }
          });
        }

        dailyLates.push(tL);
        dailyPresence.push(tP);
        labels.push(dates[i].split('-')[2]);
      });

      renderChart(labels, dailyLates, dailyPresence);

      const lateList = Object.values(stats).filter(s => s.late > 0).sort((a,b) => b.late - a.late);
      const goodList = Object.values(stats).filter(s => s.late === 0 && s.present > 0).sort((a,b) => b.present - a.present);

      let html = '<div class="space-y-8">';
      html += `<div><h3 class="text-[10px] font-black text-rose-500 uppercase tracking-[0.2em] mb-4">Top Retardataires</h3>`;
      lateList.slice(0, 5).forEach(s => {
        html += `<div class="glass-card p-5 rounded-2xl mb-3 flex justify-between items-center"><span class="text-xs font-extrabold uppercase">${s.info.nom}</span><span class="text-rose-600 font-black">${s.late}m</span></div>`;
      });
      html += `</div><div><h3 class="text-[10px] font-black text-emerald-500 uppercase tracking-[0.2em] mb-4">Les plus exemplaires</h3>`;
      goodList.slice(0, 5).forEach(s => {
        html += `<div class="glass-card p-5 rounded-2xl mb-3 flex justify-between items-center"><span class="text-xs font-extrabold uppercase">${s.info.nom}</span><span class="text-emerald-600 font-black">${s.present}j OK</span></div>`;
      });
      html += '</div></div>';

      document.getElementById('dashBody').innerHTML = html;
    }

    function renderChart(labels, lates, pres) {
      const ctx = document.getElementById('trendsChart').getContext('2d');
      if (myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            data: lates,
            borderColor: '#c5a059',
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 0,
            fill: true,
            backgroundColor: 'rgba(197, 160, 89, 0.05)'
          }]
        },
        options: {
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { display: false },
            x: { grid: { display: false }, ticks: { font: { size: 8 } } }
          }
        }
      });
    }

    // ✅ diff: si pas de planning OU hA-only => 0
    function getTimeDiff(a, p, id) {
      if(!a) return 0;
      if(!p) return 0;
      if(id && haOnlyIds.has(id)) return 0;

      const [ha,ma]=a.split(':').map(Number), [hp,mp]=p.split(':').map(Number);
      const d=(ha*60+ma)-(hp*60+mp);
      return d>0?d:0;
    }

    function getDatesInMonth() {
      const dates = [], curr = new Date(dateInput.value), m = curr.getMonth(), y = curr.getFullYear(), d = new Date(y, m, 1);
      while(d.getMonth() === m) { dates.push(d.toISOString().split('T')[0]); d.setDate(d.getDate()+1); }
      return dates;
    }

    async function openHistory(nom, prenom) {
      const modal = document.getElementById('historyModal');
      document.getElementById('modalTitle').innerText = nom;
      modal.classList.add('modal-active');

      const dates = getDatesInMonth();
      const snaps = await Promise.all(dates.map(dt => database.ref('presences/'+dt).once('value')));

      let html = '';
      snaps.reverse().forEach((s, i) => {
        const data = s.val(), id = nom+'_'+prenom, entry = data ? data[id] : null;
        if(entry) {
          const diff = getTimeDiff(entry.hA, entry.hP, id);

          // ✅ si hA existe mais pas hP => OK (chef / planning non défini)
          const label = entry.off
            ? 'Repos'
            : (entry.hA ? (entry.hP ? (diff>0?diff+'m':'OK') : 'OK') : 'Absent');

          const cls = entry.off
            ? 'text-slate-300'
            : (entry.hA ? (entry.hP ? (diff>0?'text-rose-500':'text-emerald-500') : 'text-emerald-500') : 'text-slate-400');

          html += `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100">
            <span class="text-[10px] font-black text-slate-400 uppercase">${dates.slice().reverse()[i].split('-').reverse().slice(0,2).join('/')}</span>
            <span class="text-[10px] font-black ${cls} uppercase">${label}</span>
          </div>`;
        }
      });

      document.getElementById('modalList').innerHTML = html || '<p class="text-center text-slate-300 py-10">Aucune donnée</p>';
    }

    function closeModal() { document.getElementById('historyModal').classList.remove('modal-active'); }
  </script>
</body>
</html>
