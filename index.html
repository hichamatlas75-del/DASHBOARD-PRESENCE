<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Direction Hub • Grey Corner Fès</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --grey-dark: #2c2c2c;
      --grey-light: #f4f4f4;
      --gold: #c5a059;
      --status-ok: #10b981;
      --status-late: #f59e0b;
      --status-crit: #ef4444;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--grey-light);color:var(--grey-dark);-webkit-tap-highlight-color:transparent}
    .glass-card{background:#fff;border:1px solid #e5e7eb;box-shadow:0 4px 20px -5px rgba(0,0,0,.05)}
    .view-btn{color:var(--grey-dark);border:1px solid transparent;transition:all .3s ease}
    .view-btn.active{background:var(--grey-dark);color:var(--gold);border-color:var(--gold)}
    .staff-card{border-left-width:5px;transition:transform .2s}
    .status-green{border-left-color:var(--status-ok)!important;background:#f0fdf4}
    .status-orange{border-left-color:var(--status-late)!important;background:#fffbeb}
    .status-red{border-left-color:var(--status-crit)!important;background:#fef2f2}
    .status-flash{border-left-color:var(--status-crit)!important;background:#fef2f2;animation:flash-red 1s infinite}
    @keyframes flash-red{0%{box-shadow:inset 0 0 0 #ef4444}50%{box-shadow:inset 0 0 15px rgba(239,68,68,.2);border-left-width:8px}100%{box-shadow:inset 0 0 0 #ef4444}}
    .status-off{border-left-color:#94a3b8!important;background:#f8fafc;opacity:.6}
    .modal-active{display:flex!important;animation:slideUp .4s cubic-bezier(0,0,.2,1)}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    #pdfArea{display:none;background:#fff;color:#111827}
    .pdfBox{border:1px solid #e5e7eb;border-radius:14px;padding:10px}
    .pdfKpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pdfKpi .t{font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:#6b7280;font-size:10px}
    .pdfKpi .v{font-weight:900;font-size:18px;margin-top:4px;color:#111827}
    .pdfTable{width:100%;border-collapse:collapse}
    .pdfTable th,.pdfTable td{border:1px solid #e5e7eb;padding:8px;font-size:11px}
    .pdfTable th{background:#f3f4f6;font-weight:900}
    .inpt{width:100%;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px;color:#111827;font-weight:800;font-size:12px;outline:none}
    .inpt:focus{border-color:rgba(197,160,89,.55);box-shadow:0 0 0 3px rgba(197,160,89,.15)}
    .btn-login{width:100%;border-radius:16px;padding:12px 14px;font-size:12px;font-weight:900;letter-spacing:.10em;text-transform:uppercase;background:#0f172a;color:#fff;border:1px solid #0f172a}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:9999;background:rgba(15,23,42,.92);color:#fff;padding:10px 14px;border-radius:14px;font-size:12px;font-weight:900;border:1px solid rgba(255,255,255,.12);display:none;max-width:min(440px, calc(100vw - 24px));text-align:center}
  </style>
</head>

<body class="antialiased pb-10">
  <div class="max-w-md mx-auto px-5 pt-8">

    <!-- LOGIN -->
    <div id="loginWrap" class="glass-card rounded-3xl p-5 mb-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-[10px] font-black uppercase tracking-[0.25em] text-slate-400">Accès sécurisé</div>
          <div class="text-xl font-black text-slate-900 mt-1">Connexion Gérant</div>
          <div class="text-[11px] font-bold text-[#c5a059] uppercase tracking-[0.3em] mt-1">Grey Corner Fès</div>
        </div>
        <div class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">RH</div>
      </div>

      <div class="mt-4 space-y-2">
        <input id="loginEmail" class="inpt" type="email" placeholder="Email" autocomplete="username" />
        <input id="loginPass" class="inpt" type="password" placeholder="Mot de passe" autocomplete="current-password" />
        <button id="btnLogin" class="btn-login">Se connecter</button>
        <div id="loginMsg" class="text-[11px] font-extrabold text-rose-600"></div>
      </div>
    </div>

    <!-- APP -->
    <div id="appWrap" class="hidden">
      <header class="flex justify-between items-start mb-6">
        <div>
          <h1 class="text-2xl font-black tracking-tighter text-slate-900 leading-none">RH SUPERVISION</h1>
          <p class="text-[10px] font-bold text-[#c5a059] uppercase tracking-[0.3em] mt-1">Grey Corner Fès</p>
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mt-2">
            Connecté : <span id="roleLabel" class="text-slate-900">—</span>
          </p>
          <p class="text-[10px] font-bold text-slate-400 mt-2">
            Sync temps réel : <span class="text-slate-900 font-black">punches → presences</span> ✅
          </p>
        </div>

        <div class="flex flex-col items-end gap-2">
          <button onclick="downloadPDF_Day()" class="px-4 py-2 rounded-full bg-slate-900 text-white text-[11px] font-extrabold shadow-sm">
            PDF JOUR
          </button>
          <button id="btnLogout" class="px-4 py-2 rounded-full bg-white text-slate-900 text-[11px] font-extrabold shadow-sm border border-slate-200">
            Déconnexion
          </button>
        </div>
      </header>

      <div class="mb-6 space-y-4">
        <div class="flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100">
          <button onclick="switchMode('day', this)" class="view-btn active flex-1 py-3 text-[11px] font-extrabold rounded-xl uppercase tracking-wider">Jour</button>
          <button onclick="switchMode('report', this)" class="view-btn flex-1 py-3 text-[11px] font-extrabold rounded-xl uppercase tracking-wider">Bilan Mensuel</button>
        </div>

        <div class="relative">
          <input type="date" id="dashDate" class="w-full bg-transparent border-b-2 border-slate-200 py-2 font-bold text-slate-800 outline-none">
        </div>

        <div class="glass-card rounded-2xl p-4 flex flex-col gap-3">
          <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">PDF PAR EMPLOYÉ</div>

          <select id="empSelect" class="w-full px-4 py-3 rounded-2xl border border-slate-200 font-extrabold text-slate-800 outline-none"></select>

          <div class="grid grid-cols-2 gap-2">
            <button onclick="downloadPDF_EmployeeMonth()" class="px-4 py-3 rounded-2xl bg-[#c5a059] text-white font-extrabold text-[12px]">
              PDF MOIS
            </button>
            <button onclick="downloadPDF_EmployeeYear()" class="px-4 py-3 rounded-2xl bg-slate-900 text-white font-extrabold text-[12px]">
              PDF ANNÉE
            </button>
          </div>

          <div class="text-[10px] text-slate-500 font-semibold leading-snug">
            ✅ Les dates <b>exclues</b> (01/01/2026 → 31/01/2026) ne sont <b>jamais comptabilisées</b>.
          </div>
        </div>
      </div>

      <div id="chartContainer" class="glass-card rounded-3xl p-6 mb-8 hidden">
        <div class="h-[180px] w-full">
          <canvas id="trendsChart"></canvas>
        </div>
      </div>

      <div id="dashBody" class="space-y-6"></div>
    </div>
  </div>

  <div id="historyModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-md items-end" onclick="closeModal()">
    <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 shadow-2xl" onclick="event.stopPropagation()">
      <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-8"></div>
      <h2 id="modalTitle" class="text-xl font-black text-slate-900 uppercase mb-6 tracking-tight">Historique</h2>
      <div id="modalList" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
    </div>
  </div>

  <!-- Hidden PDF -->
  <div id="pdfArea" class="p-6">
    <div id="pdfHeader" class="mb-4"></div>
    <div id="pdfKpis" class="mb-4"></div>
    <div id="pdfContent"></div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyC5al_6xWbJC8S0FAvaEnRmx9BvYtGgnAM",
      authDomain: "grey-corner-presence.firebaseapp.com",
      databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "grey-corner-presence",
      storageBucket: "grey-corner-presence.firebasestorage.app",
      messagingSenderId: "730206093359",
      appId: "1:730206093359:web:59e3c145120807f29e46da",
      measurementId: "G-4HCKPGNED7"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // ===== UI =====
    const dateInput = document.getElementById('dashDate');
    const loginWrap = document.getElementById("loginWrap");
    const appWrap = document.getElementById("appWrap");
    const roleLabel = document.getElementById("roleLabel");
    const toastEl = document.getElementById("toast");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>toastEl.style.display="none", 2400);
    }

    let currentMode = 'day', myChart = null;
    let activeDayListenerRef = null;

    // ✅ NEW: listeners pour sync temps réel
    let activePunchesListenerRef = null;
    let activePunchChildAdded = null;
    let activePunchChildChanged = null;

    let role = null;

    // ===== Équipe =====
    const equipe = [
      {nom:'BOUCHNAK', prenom:'NAOUAL', poste:'CUISINE'},
      {nom:'ALAOUI', prenom:'LAZIZ', poste:'SERVICE'}, {nom:'BELQASSE', prenom:'KHAOULA', poste:'CUISINE'},
      {nom:'BENKHADA', prenom:'ABDESLAM', poste:'CAISSE'}, {nom:'BOURAHMA', prenom:'ANAS', poste:'CUISINE'},
      {nom:'CHKAIRI', prenom:'YOUSSEF', poste:'BAR'}, {nom:'ELKOBBI', prenom:'MOSTAFA', poste:'BAR'},
      {nom:'ELGORRAMY', prenom:'ANISSA', poste:'MENAGE'}, {nom:'ELGORRAMY', prenom:'SOUAD', poste:'MENAGE'},
      {nom:'ELMCHAOURI', prenom:'SOUAD', poste:'MENAGE'}, {nom:'ENNHAILI', prenom:'SOUMIA', poste:'ECONOMAT'},
      {nom:'FILALI', prenom:'ABDERAFI', poste:'BAR'}, {nom:'GUETIBI', prenom:'AMINE', poste:'SERVICE'},
      {nom:'HATTAF', prenom:'MOHAMED', poste:'SERVICE'}, {nom:'HIDARA', prenom:'YOUSSEF', poste:'SERVICE'},
      {nom:'IDRISSI', prenom:'SAAD', poste:'CUISINE'}, {nom:'KAFOUNI', prenom:'ZAKARIAE', poste:'SERVICE'},
      {nom:'KHALOUQ', prenom:'RACHID', poste:'BAR'}, {nom:'LEMSSIEH', prenom:'JAWAD', poste:'CUISINE'},
      {nom:'MAJDOUB', prenom:'JIHANE', poste:'CUISINE'}, {nom:'MOHSINE', prenom:'YOUNESS', poste:'SERVICE'},
      {nom:'MOUJAHID', prenom:'IMANE', poste:'CUISINE'}, {nom:'SALIL', prenom:'HOUDA', poste:'CAISSE'},
      {nom:'SBAI', prenom:'HAKIMA', poste:'MENAGE'}, {nom:'ZAIR', prenom:'FATIMA', poste:'CUISINE'}
    ];

    const haOnlyIds = new Set(["BOUCHNAK_NAOUAL", "ELMCHAOURI_SOUAD", "SBAI_HAKIMA"]);
    const EXCL_START = "2026-01-01";
    const EXCL_END   = "2026-01-31";
    function isExcluded(dayISO){ return dayISO >= EXCL_START && dayISO <= EXCL_END; }

    // ===== Helpers =====
    function todayISO(){
      return new Intl.DateTimeFormat('fr-CA',{
        timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'
      }).format(new Date());
    }
    function fmtFR(iso){
      if(!iso || !iso.includes("-")) return iso || "";
      const [y,m,d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }
    function toMin(hhmm){
      if(!hhmm || typeof hhmm !== "string" || !hhmm.includes(":")) return null;
      const [h,m] = hhmm.split(":").map(Number);
      if(Number.isNaN(h) || Number.isNaN(m)) return null;
      return h*60+m;
    }
    function getTimeDiff(a, p, id) {
      if(!a) return 0;
      if(!p) return 0;
      if(id && haOnlyIds.has(id)) return 0;
      const A = toMin(a), P = toMin(p);
      if(A === null || P === null) return 0;
      const d = A - P;
      return d>0?d:0;
    }
    function getStatusClass(diff, isOff, hasArrived) {
      if (isOff) return 'status-off';
      if (!hasArrived) return '';
      if (diff <= 0) return 'status-green';
      if (diff > 0 && diff < 30) return 'status-orange';
      if (diff >= 30 && diff < 60) return 'status-red';
      if (diff >= 60) return 'status-flash';
      return '';
    }

    // ===== Auth =====
    async function fetchRole(uid){
      const s = await database.ref("users/"+uid).once("value");
      return s.val() || null;
    }
    function showLoginUI(msg){
      detachAllListeners();
      role = null;
      appWrap.classList.add("hidden");
      loginWrap.classList.remove("hidden");
      document.getElementById("loginMsg").textContent = msg || "";
    }
    function showAppUI(){
      loginWrap.classList.add("hidden");
      appWrap.classList.remove("hidden");
      roleLabel.textContent = role || "—";
    }

    document.getElementById("btnLogin").onclick = async () => {
      const email = (document.getElementById("loginEmail").value || "").trim();
      const pass  = (document.getElementById("loginPass").value || "").trim();
      document.getElementById("loginMsg").textContent = "";
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        showLoginUI("Identifiants invalides.");
      }
    };
    document.getElementById("btnLogout").onclick = async () => {
      try{ await auth.signOut(); }catch(e){}
      location.reload();
    };

    auth.onAuthStateChanged(async (user) => {
      if(!user){ showLoginUI(""); return; }

      try{
        role = await fetchRole(user.uid);
        if(role !== "gerant"){
          await auth.signOut();
          showLoginUI("Accès refusé : compte non gérant.");
          return;
        }
      }catch(e){
        try{ await auth.signOut(); }catch(_){}
        showLoginUI("Erreur d'accès.");
        return;
      }

      showAppUI();
      bootDashboard();
    });

    // ===== Boot =====
    function bootDashboard(){
      dateInput.value = todayISO();
      dateInput.addEventListener('change', updateDashboard);

      fillEmpSelect();
      updateDashboard();
    }

    function fillEmpSelect(){
      const sel = document.getElementById("empSelect");
      const list = equipe.slice().sort((a,b)=>{
        const A = a.nom+"_"+a.prenom, B = b.nom+"_"+b.prenom;
        if(A==="BOUCHNAK_NAOUAL") return -1;
        if(B==="BOUCHNAK_NAOUAL") return 1;
        return (a.nom+a.prenom).localeCompare(b.nom+b.prenom);
      });
      sel.innerHTML = list.map(e=>{
        const id = e.nom+"_"+e.prenom;
        return `<option value="${id}">${e.nom} ${e.prenom} — ${e.poste}</option>`;
      }).join("");
    }

    function switchMode(mode, btn) {
      currentMode = mode;
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('chartContainer').classList.toggle('hidden', mode !== 'report');
      updateDashboard();
    }

    // =========================
    // ✅ REAL-TIME SYNC punches -> presences
    // =========================
    async function syncOnePunchToPresences(dayISO, empId, punchVal){
      if(role !== "gerant") return;
      if(!dayISO || !empId || !punchVal || !punchVal.hA) return;

      // limiter aux IDs connus
      const known = equipe.some(e => (e.nom+"_"+e.prenom) === empId);
      if(!known) return;

      try{
        const prRef = database.ref('presences/'+dayISO+'/'+empId);
        const prSnap = await prRef.once('value');
        const pr = prSnap.val() || null;

        // déjà pointé dans presences => rien
        if(pr && pr.hA) return;

        // OUT => ne pas forcer HA
        if(pr && pr.off === true) return;

        const hp = pr ? (pr.hP || "") : "";
        const ha = punchVal.hA;

        const lateMin = (hp && !haOnlyIds.has(empId)) ? getTimeDiff(ha, hp, empId) : 0;

        const payload = {
          hA: ha,
          retard: lateMin > 0,
          retardMin: lateMin,
          timestamp: (typeof punchVal.timestamp === "number" ? punchVal.timestamp : Date.now()),
          lastEditAt: Date.now(),
          lastEditByAdmin: true
        };

        await prRef.update(payload);
        // toast discret:
        toast(`Sync ✅ ${empId.replace("_"," ")} (${ha})`);
      }catch(e){
        console.warn("syncOnePunch error:", e);
      }
    }

    async function initialSyncAllForDate(dayISO){
      // au chargement de la date, on synchronise tous les punches existants une fois
      try{
        const snap = await database.ref('punches/'+dayISO).once('value');
        const punches = snap.val() || {};
        const keys = Object.keys(punches);
        for(const empId of keys){
          const v = punches[empId];
          if(v && v.hA) await syncOnePunchToPresences(dayISO, empId, v);
        }
      }catch(e){
        console.warn("initialSyncAllForDate error:", e);
      }
    }

    function detachAllListeners(){
      if(activeDayListenerRef){ activeDayListenerRef.off(); activeDayListenerRef = null; }

      // punches realtime
      if(activePunchesListenerRef){
        if(activePunchChildAdded) activePunchesListenerRef.off('child_added', activePunchChildAdded);
        if(activePunchChildChanged) activePunchesListenerRef.off('child_changed', activePunchChildChanged);
        activePunchesListenerRef = null;
        activePunchChildAdded = null;
        activePunchChildChanged = null;
      }
    }

    function attachPunchesRealtime(dayISO){
      // détacher ancien
      if(activePunchesListenerRef){
        if(activePunchChildAdded) activePunchesListenerRef.off('child_added', activePunchChildAdded);
        if(activePunchChildChanged) activePunchesListenerRef.off('child_changed', activePunchChildChanged);
      }

      activePunchesListenerRef = database.ref('punches/'+dayISO);

      activePunchChildAdded = (snap) => {
        const empId = snap.key;
        const v = snap.val();
        if(v && v.hA) syncOnePunchToPresences(dayISO, empId, v);
      };

      activePunchChildChanged = (snap) => {
        const empId = snap.key;
        const v = snap.val();
        if(v && v.hA) syncOnePunchToPresences(dayISO, empId, v);
      };

      activePunchesListenerRef.on('child_added', activePunchChildAdded);
      activePunchesListenerRef.on('child_changed', activePunchChildChanged);
    }

    // ===== Dashboard updater =====
    function updateDashboard() {
      if(role !== "gerant") return;

      // stop old listeners
      detachAllListeners();

      const dayISO = dateInput.value;

      // ✅ 1) sync initial (punches existants)
      initialSyncAllForDate(dayISO);

      // ✅ 2) realtime: tout nouveau punch se copie automatiquement
      attachPunchesRealtime(dayISO);

      // ✅ 3) render dashboard
      if(currentMode === 'report'){
        renderReportView();
        return;
      }

      activeDayListenerRef = database.ref('presences/' + dayISO);
      activeDayListenerRef.on('value', (snap) => {
        const data = snap.val() || {};
        renderDayView(data);
      });
    }

    // ===== Render day =====
    function renderDayView(data) {
      const container = document.getElementById('dashBody');
      const groups = {};
      equipe.forEach(e => (groups[e.poste] ||= []).push(e));

      let html = '';
      Object.keys(groups).forEach(poste => {
        html += `<div class="mb-8">
          <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 ml-1">${poste}</h3>
          <div class="grid grid-cols-2 gap-4">`;

        groups[poste].slice().sort((a,b)=>{
          const A = a.nom + '_' + a.prenom;
          const B = b.nom + '_' + b.prenom;
          if(A === "BOUCHNAK_NAOUAL") return -1;
          if(B === "BOUCHNAK_NAOUAL") return 1;
          return (a.nom+a.prenom).localeCompare(b.nom+b.prenom);
        }).forEach(emp => {
          const id = emp.nom + '_' + emp.prenom;
          const d = data[id] || {};

          const diff = getTimeDiff(d.hA, d.hP, id);
          const sClass = getStatusClass(diff, d.off, !!d.hA);

          let statusText = 'ATTENTE';
          let statusColor = 'text-slate-400';

          if(d.off){
            statusText = 'REPOS';
            statusColor = 'text-slate-400';
          } else if(d.hA){
            if(d.hP){
              statusText = diff > 0 ? `${diff}m retard` : `À L'HEURE`;
              statusColor = diff > 0 ? 'text-rose-600' : 'text-emerald-600';
            } else {
              statusText = `OK`;
              statusColor = 'text-emerald-600';
            }
          }

          html += `
            <button onclick="openHistory('${emp.nom}','${emp.prenom}')" class="staff-card ${sClass} glass-card p-4 rounded-2xl text-left flex flex-col justify-between h-28">
              <div>
                <p class="text-[11px] font-extrabold uppercase text-slate-800 truncate">${emp.nom}</p>
                <p class="text-[9px] font-medium text-slate-400">${emp.prenom}</p>
              </div>
              <p class="text-[10px] font-black ${statusColor}">${statusText}</p>
            </button>`;
        });

        html += `</div></div>`;
      });

      container.innerHTML = html;
    }

    // ===== Report view (identique à ton code, gardé) =====
    async function renderReportView() {
      const dates = getDatesInMonth(dateInput.value);

      const stats = {};
      equipe.forEach(e => {
        const id = e.nom+'_'+e.prenom;
        stats[id] = { info: e, present: 0, lateMin: 0, repos: 0, conge: 0, excluded: 0 };
      });

      const snaps = await Promise.all(dates.map(d => database.ref('presences/'+d).once('value')));

      const dailyLates = [], dailyPresence = [], labels = [];
      const today = todayISO();

      snaps.forEach((s, i) => {
        const dayISO = dates[i];
        labels.push(dayISO.split('-')[2]);

        if(dayISO > today){ dailyLates.push(0); dailyPresence.push(0); return; }
        if(isExcluded(dayISO)){
          dailyLates.push(0); dailyPresence.push(0);
          Object.keys(stats).forEach(id => stats[id].excluded++);
          return;
        }

        const dData = s.val() || {};
        let tL = 0, tP = 0;

        if (!dData.disabled) {
          Object.keys(stats).forEach(id => {
            const e = dData[id] || null;

            if(!e){ stats[id].conge++; return; }
            if(e.off){ stats[id].repos++; return; }

            if(e.hA){
              const diff = getTimeDiff(e.hA, e.hP, id);
              stats[id].present++;
              stats[id].lateMin += diff;
              tL += diff; tP++;
              return;
            }
            stats[id].conge++;
          });
        }

        dailyLates.push(tL);
        dailyPresence.push(tP);
      });

      renderChart(labels, dailyLates, dailyPresence);

      const lateList = Object.values(stats).filter(s => s.lateMin > 0).sort((a,b) => b.lateMin - a.lateMin);
      const goodList = Object.values(stats).filter(s => s.lateMin === 0 && s.present > 0).sort((a,b) => b.present - a.present);

      let html = '<div class="space-y-8">';

      html += `<div>
        <h3 class="text-[10px] font-black text-rose-500 uppercase tracking-[0.2em] mb-4">Top Retardataires</h3>`;
      if(lateList.length === 0){
        html += `<div class="glass-card p-5 rounded-2xl text-center text-slate-400 font-extrabold text-[12px]">Aucun retard enregistré</div>`;
      }else{
        lateList.slice(0, 6).forEach(s => {
          html += `<div class="glass-card p-5 rounded-2xl mb-3 flex justify-between items-center">
            <span class="text-xs font-extrabold uppercase">${s.info.nom}</span>
            <span class="text-rose-600 font-black">${s.lateMin}m</span>
          </div>`;
        });
      }
      html += `</div>`;

      html += `<div>
        <h3 class="text-[10px] font-black text-emerald-500 uppercase tracking-[0.2em] mb-4">Les plus exemplaires</h3>`;
      if(goodList.length === 0){
        html += `<div class="glass-card p-5 rounded-2xl text-center text-slate-400 font-extrabold text-[12px]">Aucune présence "OK" trouvée</div>`;
      }else{
        goodList.slice(0, 6).forEach(s => {
          html += `<div class="glass-card p-5 rounded-2xl mb-3 flex justify-between items-center">
            <span class="text-xs font-extrabold uppercase">${s.info.nom}</span>
            <span class="text-emerald-600 font-black">${s.present}j OK</span>
          </div>`;
        });
      }
      html += '</div></div>';

      document.getElementById('dashBody').innerHTML = html;
    }

    function renderChart(labels, lates, presences) {
      const ctx = document.getElementById('trendsChart').getContext('2d');
      if (myChart) myChart.destroy();

      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label:"Retards (min)", data:lates, borderColor:'#c5a059', tension:.35, borderWidth:3, pointRadius:0, fill:true, backgroundColor:'rgba(197,160,89,.08)' },
            { label:"Présences (nb)", data:presences, borderColor:'#0f172a', tension:.35, borderWidth:2, pointRadius:0, fill:false }
          ]
        },
        options: {
          maintainAspectRatio:false,
          plugins:{ legend:{ display:false }, tooltip:{ enabled:true } },
          scales:{ y:{ display:false }, x:{ grid:{ display:false }, ticks:{ font:{ size:8 } } } }
        }
      });
    }

    function getDatesInMonth(seedISO) {
      const dates = [];
      const curr = new Date(seedISO);
      const m = curr.getMonth();
      const y = curr.getFullYear();
      const d = new Date(y, m, 1);
      while(d.getMonth() === m) { dates.push(d.toISOString().split('T')[0]); d.setDate(d.getDate()+1); }
      return dates;
    }

    // ===== Modal =====
    async function openHistory(nom, prenom) {
      const modal = document.getElementById('historyModal');
      document.getElementById('modalTitle').innerText = nom + " " + prenom;
      modal.classList.add('modal-active');

      const dates = getDatesInMonth(dateInput.value);
      const snaps = await Promise.all(dates.map(dt => database.ref('presences/'+dt).once('value')));

      const today = todayISO();
      let html = '';

      const datesRev = dates.slice().reverse();
      const snapsRev = snaps.slice().reverse();

      snapsRev.forEach((s, i) => {
        const dayISO = datesRev[i];
        const data = s.val() || {};
        const id = nom+'_'+prenom;
        const entry = data[id] || null;

        let label = '';
        let cls = 'text-slate-400';

        if(dayISO > today){ label='À venir'; cls='text-slate-300'; }
        else if(isExcluded(dayISO)){ label='Exclu'; cls='text-slate-400'; }
        else if(!entry){ label='Congé'; cls='text-slate-500'; }
        else if(entry.off){ label='Repos'; cls='text-slate-300'; }
        else if(entry.hA){
          const diff = getTimeDiff(entry.hA, entry.hP, id);
          label = entry.hP ? (diff>0 ? `${diff}m` : 'OK') : 'OK';
          cls = diff>0 ? 'text-rose-500' : 'text-emerald-500';
        }else{ label='Congé'; cls='text-slate-500'; }

        html += `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100">
          <span class="text-[10px] font-black text-slate-400 uppercase">${fmtFR(dayISO)}</span>
          <span class="text-[10px] font-black ${cls} uppercase">${label}</span>
        </div>`;
      });

      document.getElementById('modalList').innerHTML = html || '<p class="text-center text-slate-300 py-10">Aucune donnée</p>';
    }
    function closeModal(){ document.getElementById('historyModal').classList.remove('modal-active'); }

    // ===== PDF (placeholder: garde tes fonctions existantes, inchangées) =====
    function showPDF(el){ el.style.display="block"; }
    function hidePDF(el){ el.style.display="none"; }
    function pdfHeader(title, sub){ return `<div style="font-weight:900">${title}</div>`; }
    function kpiBox(t,v){ return `<div class="pdfBox"><div class="t">${t}</div><div class="v">${v}</div></div>`; }

    async function downloadPDF_Day(){ toast("PDF jour (fonction existante)"); }
    async function downloadPDF_EmployeeMonth(){ toast("PDF mois (fonction existante)"); }
    async function downloadPDF_EmployeeYear(){ toast("PDF année (fonction existante)"); }
  </script>
</body>
</html>