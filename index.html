<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Direction Hub • Grey Corner Fès</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
body{font-family:'Plus Jakarta Sans',sans-serif;background:#f4f4f4}
.glass-card{background:#fff;border:1px solid #e5e7eb}
.staff-card{border-left-width:5px}
.status-green{border-left-color:#10b981;background:#f0fdf4}
.status-orange{border-left-color:#f59e0b;background:#fffbeb}
.status-red{border-left-color:#ef4444;background:#fef2f2}
.status-flash{border-left-color:#ef4444;background:#fef2f2;animation:flash 1s infinite}
@keyframes flash{50%{border-left-width:8px}}
.status-off{border-left-color:#94a3b8;background:#f8fafc;opacity:.6}
.modal-active{display:flex!important}
</style>
</head>

<body class="pb-10">
<div class="max-w-md mx-auto px-5 pt-8">

<header class="flex justify-between items-start mb-10">
<div>
<h1 class="text-2xl font-black">RH SUPERVISION</h1>
<p class="text-[10px] font-bold text-[#c5a059] uppercase tracking-[0.3em] mt-1">Grey Corner Fès</p>
</div>
<button onclick="downloadDailyPDF()" class="bg-black text-white px-4 py-2 rounded-xl text-xs font-bold">
PDF JOUR
</button>
</header>

<div class="mb-6 space-y-3">
<input type="date" id="dashDate" class="w-full border-b-2 py-2 font-bold outline-none">
</div>

<div id="dashBody" class="space-y-6"></div>
</div>

<div id="historyModal" class="fixed inset-0 hidden bg-black/40 items-end" onclick="closeModal()">
<div class="bg-white w-full rounded-t-[30px] p-6" onclick="event.stopPropagation()">
<h2 id="modalTitle" class="font-black mb-4"></h2>
<div class="flex gap-2 mb-4">
<button onclick="downloadEmployeeMonthlyPDF()" class="bg-black text-white px-3 py-2 rounded-xl text-xs font-bold">PDF MOIS</button>
<button onclick="downloadEmployeeYearlyPDF()" class="bg-slate-800 text-white px-3 py-2 rounded-xl text-xs font-bold">PDF ANNÉE</button>
</div>
<div id="modalList" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig={databaseURL:"https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const haOnlyIds=new Set(["BOUCHNAK_NAOUAL"]);

const equipe=[
{nom:'BOUCHNAK',prenom:'NAOUAL',poste:'CUISINE'},
{nom:'ALAOUI',prenom:'LAZIZ',poste:'SERVICE'},
{nom:'SBAI',prenom:'HAKIMA',poste:'MENAGE'},
{nom:'ELMCHAOURI',prenom:'SOUAD',poste:'MENAGE'}
];

let selectedEmployee=null;

function getTodayISO(){
return new Intl.DateTimeFormat('fr-CA',{timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());
}
function isFuture(d){return d>getTodayISO();}
function getTimeDiff(a,p,id){
if(!a)return 0;
if(!p)return 0;
if(haOnlyIds.has(id))return 0;
const[ha,ma]=a.split(':').map(Number);
const[hp,mp]=p.split(':').map(Number);
return Math.max(0,(ha*60+ma)-(hp*60+mp));
}

document.getElementById('dashDate').value=getTodayISO();
document.getElementById('dashDate').addEventListener('change',updateDashboard);
updateDashboard();

function updateDashboard(){
db.ref('presences/'+dashDate.value).on('value',snap=>{
renderDayView(snap.val()||{});
});
}

function renderDayView(data){
let html='';
equipe.forEach(emp=>{
const id=emp.nom+'_'+emp.prenom;
const d=data[id]||{};
const diff=getTimeDiff(d.hA,d.hP,id);
let cls='',txt='ATTENTE';
if(d.off){cls='status-off';txt='REPOS';}
else if(d.hA){
if(d.hP) txt=diff>0?diff+'m retard':'À L\'HEURE';
else txt='OK';
}
html+=`
<button onclick="openHistory('${emp.nom}','${emp.prenom}')" class="staff-card ${cls} glass-card p-4 rounded-xl flex justify-between items-center">
<div>
<p class="font-bold text-xs">${emp.nom}</p>
<p class="text-[10px] text-gray-500">${emp.prenom}</p>
</div>
<span class="text-xs font-bold">${txt}</span>
</button>`;
});
dashBody.innerHTML=html;
}

function openHistory(nom,prenom){
selectedEmployee=nom+'_'+prenom;
modalTitle.innerText=nom+' '+prenom;
historyModal.classList.add('modal-active');

const dates=getDatesInMonth();
Promise.all(dates.map(d=>db.ref('presences/'+d).once('value')))
.then(snaps=>{
let html='';
snaps.forEach((s,i)=>{
const dt=dates[i];
const data=s.val();
const entry=data?data[selectedEmployee]:null;

if(isFuture(dt)){
html+=row(dt,'À venir');
return;
}
if(!entry){
html+=row(dt,'Congé');
return;
}
if(entry.off){html+=row(dt,'Repos');return;}
if(entry.hA){
const diff=getTimeDiff(entry.hA,entry.hP,selectedEmployee);
html+=row(dt,entry.hP?(diff>0?diff+'m':'OK'):'OK');
}else html+=row(dt,'Absent');
});
modalList.innerHTML=html;
});
}

function row(d,s){return `<div class="flex justify-between bg-gray-50 p-2 rounded-xl text-xs">
<span>${d.split('-').reverse().slice(0,2).join('/')}</span><span class="font-bold">${s}</span></div>`;}

function closeModal(){historyModal.classList.remove('modal-active');}

function getDatesInMonth(){
const arr=[],d=new Date(dashDate.value),m=d.getMonth(),y=d.getFullYear();
let cur=new Date(y,m,1);
while(cur.getMonth()==m){
arr.push(cur.toISOString().split('T')[0]);
cur.setDate(cur.getDate()+1);
}
return arr;
}
function getDatesInYear(){
const arr=[],y=new Date(dashDate.value).getFullYear();
let cur=new Date(y,0,1);
while(cur.getFullYear()==y){
arr.push(cur.toISOString().split('T')[0]);
cur.setDate(cur.getDate()+1);
}
return arr;
}

function downloadDailyPDF(){
db.ref('presences/'+dashDate.value).once('value').then(snap=>{
const data=snap.val()||{};
let rows='';
equipe.forEach(emp=>{
const id=emp.nom+'_'+emp.prenom;
const d=data[id]||{};
rows+=`<tr><td>${emp.nom}</td><td>${d.hA||''}</td><td>${d.hP||''}</td></tr>`;
});
generatePDF(`<h2>Rapport ${dashDate.value}</h2><table border="1" width="100%">${rows}</table>`,'RAPPORT_JOUR');
});
}

function downloadEmployeeMonthlyPDF(){
const dates=getDatesInMonth();
Promise.all(dates.map(d=>db.ref('presences/'+d).once('value')))
.then(snaps=>{
let rows='';
snaps.forEach((s,i)=>{
const dt=dates[i];
if(isFuture(dt)){rows+=pdfRow(dt,'À venir');return;}
const data=s.val();
const entry=data?data[selectedEmployee]:null;
if(!entry){rows+=pdfRow(dt,'Congé');return;}
if(entry.off){rows+=pdfRow(dt,'Repos');return;}
if(entry.hA){
const diff=getTimeDiff(entry.hA,entry.hP,selectedEmployee);
rows+=pdfRow(dt,entry.hP?(diff>0?diff+'m':'OK'):'OK');
}else rows+=pdfRow(dt,'Absent');
});
generatePDF(`<h2>Bilan Mensuel</h2><table border="1" width="100%">${rows}</table>`,'MOIS_'+selectedEmployee);
});
}

function downloadEmployeeYearlyPDF(){
const dates=getDatesInYear();
Promise.all(dates.map(d=>db.ref('presences/'+d).once('value')))
.then(snaps=>{
let rows='';
snaps.forEach((s,i)=>{
const dt=dates[i];
if(isFuture(dt)){rows+=pdfRow(dt,'À venir');return;}
const data=s.val();
const entry=data?data[selectedEmployee]:null;
if(!entry){rows+=pdfRow(dt,'Congé');return;}
if(entry.off){rows+=pdfRow(dt,'Repos');return;}
if(entry.hA){
const diff=getTimeDiff(entry.hA,entry.hP,selectedEmployee);
rows+=pdfRow(dt,entry.hP?(diff>0?diff+'m':'OK'):'OK');
}else rows+=pdfRow(dt,'Absent');
});
generatePDF(`<h2>Bilan Annuel</h2><table border="1" width="100%">${rows}</table>`,'ANNEE_'+selectedEmployee);
});
}

function pdfRow(d,s){return `<tr><td>${d}</td><td>${s}</td></tr>`;}

function generatePDF(content,name){
const el=document.createElement('div');
el.innerHTML=content;
html2pdf().from(el).set({
margin:10,
filename:name+'.pdf',
html2canvas:{scale:2},
jsPDF:{unit:'mm',format:'a4'}
}).save();
}
</script>
</body>
</html>