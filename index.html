<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Direction Hub • Grey Corner Fès</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #1e293b;
      --accent: #4f46e5;
      --bg: #f8fafc;
    }

    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background: var(--bg); 
      color: var(--primary); 
      -webkit-tap-highlight-color: transparent;
    }

    /* Esthétique Cartes Style Pointage */
    .glass-card { 
      background: #ffffff; 
      border: 1px solid #e2e8f0; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .view-btn {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid transparent;
    }
    .view-btn.active { 
      background: var(--primary); 
      color: white; 
      box-shadow: 0 4px 12px rgba(30, 41, 59, 0.2);
    }

    /* Status Indicators */
    .staff-card {
      transition: transform 0.1s active;
      border-left-width: 4px;
    }
    .staff-card:active { transform: scale(0.97); }

    .status-on-time { border-left-color: #10b981 !important; background: #f0fdf4; }
    .status-late { border-left-color: #f59e0b !important; background: #fffbeb; }
    .status-critical { border-left-color: #dc2626 !important; background: #fef2f2; animation: pulse-red 2s infinite; }
    @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    .status-off { border-left-color: #94a3b8 !important; background: #f1f5f9; opacity: 0.6; }
    .status-missing { border-left-color: #e2e8f0 !important; background: #ffffff; }

    /* Modal Animation */
    .modal-active { display: flex !important; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateY(20%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Hide Scrollbar */
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>

<body class="antialiased pb-10">
  <div class="max-w-md mx-auto px-4 pt-6">
    
    <header class="flex justify-between items-end mb-8">
      <div>
        <p class="text-[10px] font-extrabold text-indigo-600 uppercase tracking-[0.2em] mb-1">Direction Hub</p>
        <h1 class="text-2xl font-black text-slate-900 leading-none">PRÉSENCE</h1>
      </div>

      <button id="excludeBtn" onclick="toggleExclusion()" class="flex flex-col items-center gap-1">
        <div id="excludeIcon" class="w-10 h-10 rounded-2xl flex items-center justify-center bg-white border border-slate-200 shadow-sm transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636" />
          </svg>
        </div>
        <span id="excludeLabel" class="text-[8px] font-bold uppercase text-slate-400">Exclure</span>
      </button>
    </header>

    <div class="space-y-4 mb-8">
      <div class="relative">
        <input type="date" id="dashDate" 
          class="w-full bg-white border border-slate-200 rounded-2xl px-5 py-4 font-bold text-slate-800 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none appearance-none">
        <div class="absolute right-5 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
      </div>

      <div class="flex bg-slate-200/50 p-1.5 rounded-[20px] gap-1">
        <button onclick="switchMode('day', this)" class="view-btn active flex-1 py-3 text-[10px] font-black rounded-[14px] uppercase">Jour</button>
        <button onclick="switchMode('week', this)" class="view-btn flex-1 py-3 text-[10px] font-black rounded-[14px] uppercase">Sem</button>
        <button onclick="switchMode('month', this)" class="view-btn flex-1 py-3 text-[10px] font-black rounded-[14px] uppercase">Mois</button>
        <button onclick="switchMode('report', this)" class="view-btn flex-1 py-3 text-[10px] font-black rounded-[14px] uppercase text-rose-600">Bilan</button>
      </div>
    </div>

    <div id="chartContainer" class="glass-card rounded-[24px] p-5 mb-8 hidden">
      <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4">Tendance de ponctualité</p>
      <div class="h-[160px] w-full">
        <canvas id="trendsChart"></canvas>
      </div>
    </div>

    <div id="dashBody" class="space-y-8 pb-10"></div>
  </div>

  <div id="historyModal" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm items-end" onclick="closeModal()">
    <div class="bg-white w-full rounded-t-[40px] shadow-2xl p-6 pb-10 max-h-[85vh] flex flex-col" onclick="event.stopPropagation()">
      <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
      
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 id="modalTitle" class="text-xl font-black text-slate-900 uppercase italic">Historique</h2>
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Récapitulatif mensuel</p>
        </div>
        <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-600">✕</button>
      </div>

      <div id="modalList" class="overflow-y-auto space-y-3 no-scrollbar"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // Config Firebase
    const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const TZ = 'Africa/Casablanca';
    const dateInput = document.getElementById('dashDate');
    let currentMode = 'day';
    let isExcluded = false;
    let myChart = null;
    let currentRef = null;
    let currentCb = null;

    // Equipe
    const equipe = [
      {nom: 'ALAOUI', prenom: 'LAZIZ', poste: 'SERVICE'}, {nom: 'BELQASSE', prenom: 'KHAOULA', poste: 'CUISINE'},
      {nom: 'BENKHADA', prenom: 'ABDESLAM', poste: 'CAISSE'}, {nom: 'BOURAHMA', prenom: 'ANAS', poste: 'CUISINE'},
      {nom: 'CHKAIRI', prenom: 'YOUSSEF', poste: 'BAR'}, {nom: 'ELKOBBI', prenom: 'MOSTAFA', poste: 'BAR'},
      {nom: 'ELGORRAMY', prenom: 'ANISSA', poste: 'MENAGE'}, {nom: 'ELGORRAMY', prenom: 'SOUAD', poste: 'MENAGE'},
      {nom: 'ELMCHAOURI', prenom: 'SOUAD', poste: 'MENAGE'}, {nom: 'ENNHAILI', prenom: 'SOUMIA', poste: 'ECONOMAT'},
      {nom: 'FILALI', prenom: 'ABDERAFI', poste: 'BAR'}, {nom: 'GUETIBI', prenom: 'AMINE', poste: 'SERVICE'},
      {nom: 'HATTAF', prenom: 'MOHAMED', poste: 'SERVICE'}, {nom: 'HIDARA', prenom: 'YOUSSEF', poste: 'SERVICE'},
      {nom: 'IDRISSI', prenom: 'SAAD', poste: 'CUISINE'}, {nom: 'KAFOUNI', prenom: 'ZAKARIAE', poste: 'SERVICE'},
      {nom: 'KHALOUQ', prenom: 'RACHID', poste: 'BAR'}, {nom: 'LEMSSIEH', prenom: 'JAWAD', poste: 'CUISINE'},
      {nom: 'MAJDOUB', prenom: 'JIHANE', poste: 'CUISINE'}, {nom: 'MOHSINE', prenom: 'YOUNESS', poste: 'SERVICE'},
      {nom: 'MOUJAHID', prenom: 'IMANE', poste: 'CUISINE'}, {nom: 'SALIL', prenom: 'HOUDA', poste: 'CAISSE'},
      {nom: 'SBAI', prenom: 'HAKIMA', poste: 'MENAGE'}, {nom: 'ZAIR', prenom: 'FATIMA', poste: 'CUISINE'}
    ];

    const POSTE_ORDER = ['SERVICE', 'BAR', 'CUISINE', 'CAISSE', 'ECONOMAT', 'MENAGE'];

    // Initialisation
    const getMarocDate = () => new Intl.DateTimeFormat('fr-CA', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date());
    dateInput.value = getMarocDate();
    dateInput.addEventListener('change', updateDashboard);
    updateDashboard();

    function switchMode(mode, btn) {
      currentMode = mode;
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('chartContainer').classList.toggle('hidden', mode !== 'report');
      updateDashboard();
    }

    function toggleExclusion() {
      database.ref('presences/' + dateInput.value + '/disabled').transaction(v => !v);
    }

    function updateDashboard() {
      if (currentRef && currentCb) currentRef.off('value', currentCb);
      currentRef = database.ref('presences/' + dateInput.value);
      currentCb = (snap) => {
        const data = snap.val() || {};
        isExcluded = data.disabled === true;
        updateExcludeUI(isExcluded);
        if (currentMode === 'day') renderDayView(data);
        else if (currentMode === 'report') renderReportView();
        else renderRangeView();
      };
      currentRef.on('value', currentCb);
    }

    function updateExcludeUI(excluded) {
      const icon = document.getElementById('excludeIcon');
      icon.className = excluded 
        ? "w-10 h-10 rounded-2xl flex items-center justify-center bg-rose-500 text-white shadow-lg border-none"
        : "w-10 h-10 rounded-2xl flex items-center justify-center bg-white text-slate-400 border border-slate-200 shadow-sm";
      document.getElementById('excludeLabel').innerText = excluded ? "Exclu" : "Exclure";
      document.getElementById('excludeLabel').className = `text-[8px] font-bold uppercase ${excluded ? 'text-rose-500' : 'text-slate-400'}`;
    }

    // Rendu Jour (Mobile Optimized Grid)
    function renderDayView(data) {
      const container = document.getElementById('dashBody');
      const groups = groupByPoste(equipe);
      const postes = sortedPostes(groups);
      let html = '';

      postes.forEach(poste => {
        html += `<div class="mb-6">
          <div class="flex justify-between items-center mb-3 px-1">
            <h3 class="text-[11px] font-black uppercase tracking-[0.15em] text-slate-400">${poste}</h3>
            <span class="bg-slate-200 text-slate-600 text-[9px] font-bold px-2 py-0.5 rounded-full">${groups[poste].length} pers.</span>
          </div>
          <div class="grid grid-cols-2 gap-3">`;

        groups[poste].forEach(emp => {
          const id = idEnc(emp.nom, emp.prenom);
          const d = data[id] || {};
          const diff = getTimeDiff(d.hA, d.hP);
          const sClass = d.off ? "status-off" : (d.hA ? (diff >= 60 ? "status-critical" : (diff > 10 ? "status-late" : "status-on-time")) : "status-missing");
          
          html += `
            <button onclick="openHistory('${emp.nom}','${emp.prenom}')" class="staff-card ${sClass} glass-card p-4 rounded-2xl text-left flex flex-col justify-between h-28 relative overflow-hidden ${isExcluded ? 'opacity-30' : ''}">
              <div class="z-10">
                <p class="text-[10px] font-black text-slate-800 uppercase truncate">${emp.nom}</p>
                <p class="text-[9px] font-medium text-slate-500 truncate">${emp.prenom}</p>
              </div>
              <div class="z-10 mt-auto">
                <p class="text-[8px] font-bold text-slate-400 uppercase">${d.off ? 'REPOS' : 'P:'+(d.hP||'--')+' A:'+(d.hA||'--')}</p>
                <p class="text-xs font-black ${diff > 0 ? 'text-amber-600' : 'text-emerald-600'}">${d.off ? '-' : (d.hA ? (diff > 0 ? '-'+diff+'m' : 'OK') : '...')}</p>
              </div>
            </button>`;
        });
        html += `</div></div>`;
      });
      container.innerHTML = html;
    }

    // Logique helpers inchangée
    function idEnc(nom, prenom) { return nom + '_' + prenom; }
    function groupByPoste(list) {
      const map = {};
      list.forEach(e => { (map[e.poste] ||= []).push(e); });
      return map;
    }
    function sortedPostes(groups) {
      return POSTE_ORDER.filter(p => groups[p]);
    }
    function getTimeDiff(a, p) {
      if (!a || !p) return 0;
      const [ha, ma] = a.split(':').map(Number);
      const [hp, mp] = p.split(':').map(Number);
      const d = (ha * 60 + ma) - (hp * 60 + mp);
      return d > 0 ? d : 0;
    }

    async function openHistory(nom, prenom) {
      const modal = document.getElementById('historyModal');
      document.getElementById('modalTitle').innerText = `${nom} ${prenom}`;
      modal.classList.add('modal-active');
      const list = document.getElementById('modalList');
      list.innerHTML = '<div class="text-center py-10 animate-pulse font-bold text-slate-300">CHARGEMENT...</div>';

      const dates = getDatesInRange('month');
      const promises = dates.map(dt => database.ref('presences/' + dt).once('value'));
      const snaps = await Promise.all(promises);

      let html = '';
      snaps.reverse().forEach((s, idx) => {
        const dStr = dates.slice().reverse()[idx];
        const data = s.val();
        const entry = data ? data[idEnc(nom, prenom)] : null;
        if (entry) {
          const diff = getTimeDiff(entry.hA, entry.hP);
          html += `
            <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100">
              <span class="text-[10px] font-black text-slate-400 uppercase">${dStr.split('-').reverse().slice(0,2).join('/')}</span>
              <div class="text-right">
                <p class="text-[10px] font-black ${entry.off?'text-slate-400':(diff>0?'text-amber-500':'text-emerald-500')} uppercase">
                  ${entry.off ? 'Repos' : (entry.hA ? (diff>0?'-'+diff+'m':'Présent') : 'Non pointé')}
                </p>
                <p class="text-[8px] font-bold text-slate-300 uppercase">${entry.hP||'--'}:${entry.hA||'--'}</p>
              </div>
            </div>`;
        }
      });
      list.innerHTML = html || '<p class="text-center py-10 text-slate-400">Aucune donnée</p>';
    }

    function closeModal() { document.getElementById('historyModal').classList.remove('modal-active'); }

    // Fonctions manquantes pour Bilan/Range
    function formatLocalYYYYMMDD(d) {
      return d.toISOString().split('T')[0];
    }

    function getDatesInRange(mode) {
      const dates = [];
      const curr = new Date(dateInput.value);
      if (mode === 'week') {
        const day = curr.getDay();
        const diff = curr.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(curr.setDate(diff));
        for(let i=0; i<7; i++) {
          dates.push(formatLocalYYYYMMDD(new Date(monday)));
          monday.setDate(monday.getDate() + 1);
        }
      } else {
        const m = curr.getMonth(), y = curr.getFullYear();
        const d = new Date(y, m, 1);
        while (d.getMonth() === m) {
          dates.push(formatLocalYYYYMMDD(new Date(d)));
          d.setDate(d.getDate() + 1);
        }
      }
      return dates;
    }

    async function calculateStats(dates) {
      const stats = {};
      equipe.forEach(e => stats[idEnc(e.nom, e.prenom)] = { info: e, present: 0, lateMinutes: 0 });
      const snaps = await Promise.all(dates.map(d => database.ref('presences/' + d).once('value')));
      snaps.forEach(s => {
        const data = s.val();
        if (!data || data.disabled) return;
        Object.keys(stats).forEach(id => {
          const entry = data[id];
          if (entry && entry.hA && !entry.off) {
            stats[id].present++;
            stats[id].lateMinutes += getTimeDiff(entry.hA, entry.hP);
          }
        });
      });
      return stats;
    }

    async function renderRangeView() {
      const stats = await calculateStats(getDatesInRange(currentMode));
      const groups = groupByPoste(equipe);
      let html = '';
      sortedPostes(groups).forEach(poste => {
        html += `<div class="mb-6"><h3 class="text-[11px] font-black uppercase text-slate-400 mb-3 tracking-widest px-1">${poste}</h3><div class="grid grid-cols-2 gap-3">`;
        groups[poste].forEach(emp => {
          const s = stats[idEnc(emp.nom, emp.prenom)];
          html += `
            <button onclick="openHistory('${emp.nom}','${emp.prenom}')" class="glass-card p-4 rounded-2xl text-left border-l-4 ${s.lateMinutes > 0 ? 'border-amber-400 bg-amber-50/30' : 'border-emerald-400'}">
              <p class="text-[10px] font-black text-slate-800 uppercase truncate">${emp.nom}</p>
              <div class="mt-2">
                <p class="text-[8px] font-bold text-slate-400 uppercase">${s.present} Jours OK</p>
                <p class="text-xs font-black ${s.lateMinutes > 0 ? 'text-amber-600' : 'text-emerald-600'}">${s.lateMinutes}m retard</p>
              </div>
            </button>`;
        });
        html += `</div></div>`;
      });
      document.getElementById('dashBody').innerHTML = html;
    }

    async function renderReportView() {
      const dates = getDatesInRange('month');
      const stats = await calculateStats(dates);
      const lateList = Object.values(stats).filter(s => s.lateMinutes > 0).sort((a,b) => b.lateMinutes - a.lateMinutes);
      
      let html = '<div class="space-y-6">';
      html += '<div><h3 class="text-rose-500 font-black uppercase text-[10px] mb-3 tracking-widest px-1">Top Retards (Mois)</h3>';
      lateList.slice(0, 8).forEach(s => {
        html += `<div onclick="openHistory('${s.info.nom}','${s.info.prenom}')" class="glass-card p-4 rounded-2xl mb-2 flex justify-between items-center"><span class="text-xs font-black uppercase">${s.info.nom}</span><span class="text-rose-600 font-black">${s.lateMinutes}m</span></div>`;
      });
      html += '</div></div>';
      document.getElementById('dashBody').innerHTML = html;
    }
  </script>
</body>
</html>
