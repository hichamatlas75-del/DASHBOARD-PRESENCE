<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Direction Hub • Grey Corner Fès</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ✅ PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --grey-dark: #2c2c2c;
      --grey-light: #f4f4f4;
      --gold: #c5a059;
      --gold-light: #e2cfab;
      --status-ok: #10b981;
      --status-late: #f59e0b;
      --status-crit: #ef4444;
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--grey-light);
      color: var(--grey-dark);
      -webkit-tap-highlight-color: transparent;
    }

    .glass-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05);
    }

    .view-btn {
      color: var(--grey-dark);
      border: 1px solid transparent;
      transition: all 0.3s ease;
    }
    .view-btn.active {
      background: var(--grey-dark);
      color: var(--gold);
      border-color: var(--gold);
    }

    .staff-card { border-left-width: 5px; transition: transform 0.2s; }
    .status-green { border-left-color: var(--status-ok) !important; background: #f0fdf4; }
    .status-orange { border-left-color: var(--status-late) !important; background: #fffbeb; }
    .status-red { border-left-color: var(--status-crit) !important; background: #fef2f2; }

    .status-flash {
      border-left-color: var(--status-crit) !important;
      background: #fef2f2;
      animation: flash-red 1s infinite;
    }
    @keyframes flash-red {
      0% { box-shadow: inset 0 0 0px #ef4444; }
      50% { box-shadow: inset 0 0 15px rgba(239, 68, 68, 0.2); border-left-width: 8px; }
      100% { box-shadow: inset 0 0 0px #ef4444; }
    }

    .status-off { border-left-color: #94a3b8 !important; background: #f8fafc; opacity: 0.6; }

    .modal-active { display: flex !important; animation: slideUp 0.4s cubic-bezier(0, 0, 0.2, 1); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* ✅ PDF hidden area */
    #pdfArea{display:none;background:#fff;color:#111827}
    .pdfBox{border:1px solid #e5e7eb;border-radius:14px;padding:10px}
    .pdfKpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pdfKpi .t{font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:#6b7280;font-size:10px}
    .pdfKpi .v{font-weight:900;font-size:18px;margin-top:4px;color:#111827}
    .pdfTable{width:100%;border-collapse:collapse}
    .pdfTable th,.pdfTable td{border:1px solid #e5e7eb;padding:8px;font-size:11px}
    .pdfTable th{background:#f3f4f6;font-weight:900}

    /* ✅ Login UI */
    .inpt{
      width:100%;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:12px 12px;
      color:#111827;
      font-weight:800;
      font-size:12px;
      outline:none;
    }
    .inpt:focus{ border-color: rgba(197,160,89,.55); box-shadow: 0 0 0 3px rgba(197,160,89,.15); }
    .btn-login{
      width:100%;
      border-radius:16px;
      padding:12px 14px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      background:#0f172a;
      color:#fff;
      border:1px solid #0f172a;
    }
  </style>
</head>

<body class="antialiased pb-10">
  <div class="max-w-md mx-auto px-5 pt-8">

    <!-- ✅ LOGIN (GÉRANT ONLY) -->
    <div id="loginWrap" class="glass-card rounded-3xl p-5 mb-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-[10px] font-black uppercase tracking-[0.25em] text-slate-400">Accès sécurisé</div>
          <div class="text-xl font-black text-slate-900 mt-1">Connexion Gérant</div>
          <div class="text-[11px] font-bold text-[#c5a059] uppercase tracking-[0.3em] mt-1">Grey Corner Fès</div>
        </div>
        <div class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">RH</div>
      </div>

      <div class="mt-4 space-y-2">
        <input id="loginEmail" class="inpt" type="email" placeholder="Email" autocomplete="username" />
        <input id="loginPass" class="inpt" type="password" placeholder="Mot de passe" autocomplete="current-password" />
        <button id="btnLogin" class="btn-login">Se connecter</button>
        <div id="loginMsg" class="text-[11px] font-extrabold text-rose-600"></div>
      </div>
    </div>

    <!-- ✅ APP (hidden until gerant authenticated) -->
    <div id="appWrap" class="hidden">
      <header class="flex justify-between items-start mb-6">
        <div>
          <h1 class="text-2xl font-black tracking-tighter text-slate-900 leading-none">RH SUPERVISION</h1>
          <p class="text-[10px] font-bold text-[#c5a059] uppercase tracking-[0.3em] mt-1">Grey Corner Fès</p>
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mt-2">
            Connecté : <span id="roleLabel" class="text-slate-900">—</span>
          </p>
        </div>

        <!-- ✅ Actions -->
        <div class="flex flex-col items-end gap-2">
          <button onclick="downloadPDF_Day()" class="px-4 py-2 rounded-full bg-slate-900 text-white text-[11px] font-extrabold shadow-sm">
            PDF JOUR
          </button>
          <button id="btnLogout" class="px-4 py-2 rounded-full bg-white text-slate-900 text-[11px] font-extrabold shadow-sm border border-slate-200">
            Déconnexion
          </button>
        </div>
      </header>

      <div class="mb-6 space-y-4">
        <div class="flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100">
          <button onclick="switchMode('day', this)" class="view-btn active flex-1 py-3 text-[11px] font-extrabold rounded-xl uppercase tracking-wider">Jour</button>
          <button onclick="switchMode('report', this)" class="view-btn flex-1 py-3 text-[11px] font-extrabold rounded-xl uppercase tracking-wider">Bilan Mensuel</button>
        </div>

        <div class="relative">
          <input type="date" id="dashDate" class="w-full bg-transparent border-b-2 border-slate-200 py-2 font-bold text-slate-800 outline-none">
        </div>

        <!-- ✅ PDF employé (Mois / Année) -->
        <div class="glass-card rounded-2xl p-4 flex flex-col gap-3">
          <div class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">PDF PAR EMPLOYÉ</div>

          <select id="empSelect" class="w-full px-4 py-3 rounded-2xl border border-slate-200 font-extrabold text-slate-800 outline-none">
            <!-- rempli en JS -->
          </select>

          <div class="grid grid-cols-2 gap-2">
            <button onclick="downloadPDF_EmployeeMonth()" class="px-4 py-3 rounded-2xl bg-[#c5a059] text-white font-extrabold text-[12px]">
              PDF MOIS
            </button>
            <button onclick="downloadPDF_EmployeeYear()" class="px-4 py-3 rounded-2xl bg-slate-900 text-white font-extrabold text-[12px]">
              PDF ANNÉE
            </button>
          </div>

          <div class="text-[10px] text-slate-500 font-semibold leading-snug">
            ✅ Les dates <b>exclues</b> (01/01/2026 → 31/01/2026) ne sont <b>jamais comptabilisées</b> (ni congé, ni absent, ni repos).
          </div>
        </div>
      </div>

      <div id="chartContainer" class="glass-card rounded-3xl p-6 mb-8 hidden">
        <div class="h-[180px] w-full">
          <canvas id="trendsChart"></canvas>
        </div>
      </div>

      <div id="dashBody" class="space-y-6"></div>
    </div>
  </div>

  <div id="historyModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-md items-end" onclick="closeModal()">
    <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 shadow-2xl" onclick="event.stopPropagation()">
      <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-8"></div>
      <h2 id="modalTitle" class="text-xl font-black text-slate-900 uppercase mb-6 tracking-tight">Historique</h2>
      <div id="modalList" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
    </div>
  </div>

  <!-- ✅ Hidden PDF container -->
  <div id="pdfArea" class="p-6">
    <div id="pdfHeader" class="mb-4"></div>
    <div id="pdfKpis" class="mb-4"></div>
    <div id="pdfContent"></div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ===== Firebase (même projet que pointage/présences) =====
    const firebaseConfig = {
      apiKey: "AIzaSyC5al_6xWbJC8S0FAvaEnRmx9BvYtGgnAM",
      authDomain: "grey-corner-presence.firebaseapp.com",
      databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "grey-corner-presence",
      storageBucket: "grey-corner-presence.firebasestorage.app",
      messagingSenderId: "730206093359",
      appId: "1:730206093359:web:59e3c145120807f29e46da",
      measurementId: "G-4HCKPGNED7"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // ===== UI refs =====
    const dateInput = document.getElementById('dashDate');
    const loginWrap = document.getElementById("loginWrap");
    const appWrap = document.getElementById("appWrap");
    const roleLabel = document.getElementById("roleLabel");

    let currentMode = 'day', myChart = null;
    let activeDayListenerRef = null;
    let role = null; // must be "gerant"

    // ✅ Équipe (chef + tout le monde)
    const equipe = [
      {nom:'BOUCHNAK', prenom:'NAOUAL', poste:'CUISINE'},
      {nom:'ALAOUI', prenom:'LAZIZ', poste:'SERVICE'}, {nom:'BELQASSE', prenom:'KHAOULA', poste:'CUISINE'},
      {nom:'BENKHADA', prenom:'ABDESLAM', poste:'CAISSE'}, {nom:'BOURAHMA', prenom:'ANAS', poste:'CUISINE'},
      {nom:'CHKAIRI', prenom:'YOUSSEF', poste:'BAR'}, {nom:'ELKOBBI', prenom:'MOSTAFA', poste:'BAR'},
      {nom:'ELGORRAMY', prenom:'ANISSA', poste:'MENAGE'}, {nom:'ELGORRAMY', prenom:'SOUAD', poste:'MENAGE'},
      {nom:'ELMCHAOURI', prenom:'SOUAD', poste:'MENAGE'}, {nom:'ENNHAILI', prenom:'SOUMIA', poste:'ECONOMAT'},
      {nom:'FILALI', prenom:'ABDERAFI', poste:'BAR'}, {nom:'GUETIBI', prenom:'AMINE', poste:'SERVICE'},
      {nom:'HATTAF', prenom:'MOHAMED', poste:'SERVICE'}, {nom:'HIDARA', prenom:'YOUSSEF', poste:'SERVICE'},
      {nom:'IDRISSI', prenom:'SAAD', poste:'CUISINE'}, {nom:'KAFOUNI', prenom:'ZAKARIAE', poste:'SERVICE'},
      {nom:'KHALOUQ', prenom:'RACHID', poste:'BAR'}, {nom:'LEMSSIEH', prenom:'JAWAD', poste:'CUISINE'},
      {nom:'MAJDOUB', prenom:'JIHANE', poste:'CUISINE'}, {nom:'MOHSINE', prenom:'YOUNESS', poste:'SERVICE'},
      {nom:'MOUJAHID', prenom:'IMANE', poste:'CUISINE'}, {nom:'SALIL', prenom:'HOUDA', poste:'CAISSE'},
      {nom:'SBAI', prenom:'HAKIMA', poste:'MENAGE'}, {nom:'ZAIR', prenom:'FATIMA', poste:'CUISINE'}
    ];

    // ✅ Exception "hA-only" (retard=0 si pas de HP ou exception)
    // -> ajout demandé: ELMCHAOURI SOUAD + SBAI HAKIMA
    const haOnlyIds = new Set(["BOUCHNAK_NAOUAL", "ELMCHAOURI_SOUAD", "SBAI_HAKIMA"]);

    // ✅ EXCLUSION: du 2026-01-01 au 2026-01-31 (inclus) => jamais comptabilisé
    const EXCL_START = "2026-01-01";
    const EXCL_END   = "2026-01-31";
    function isExcluded(dayISO){ return dayISO >= EXCL_START && dayISO <= EXCL_END; }

    // ===== Helpers date (Casablanca) =====
    function todayISO(){
      return new Intl.DateTimeFormat('fr-CA',{
        timeZone:'Africa/Casablanca',
        year:'numeric',month:'2-digit',day:'2-digit'
      }).format(new Date());
    }
    function fmtFR(iso){
      if(!iso || !iso.includes("-")) return iso || "";
      const [y,m,d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }

    function getTimeDiff(a, p, id) {
      if(!a) return 0;
      if(!p) return 0;
      if(id && haOnlyIds.has(id)) return 0;
      const [ha,ma]=a.split(':').map(Number), [hp,mp]=p.split(':').map(Number);
      const d=(ha*60+ma)-(hp*60+mp);
      return d>0?d:0;
    }

    function getStatusClass(diff, isOff, hasArrived) {
      if (isOff) return 'status-off';
      if (!hasArrived) return '';
      if (diff <= 0) return 'status-green';
      if (diff > 0 && diff < 30) return 'status-orange';
      if (diff >= 30 && diff < 60) return 'status-red';
      if (diff >= 60) return 'status-flash';
      return '';
    }

    // ===== Auth (GERANT only) =====
    async function fetchRole(uid){
      const s = await database.ref("users/"+uid).once("value");
      return s.val() || null;
    }

    function showLoginUI(msg){
      if(activeDayListenerRef){ activeDayListenerRef.off(); activeDayListenerRef = null; }
      role = null;

      appWrap.classList.add("hidden");
      loginWrap.classList.remove("hidden");
      document.getElementById("loginMsg").textContent = msg || "";
    }

    function showAppUI(){
      loginWrap.classList.add("hidden");
      appWrap.classList.remove("hidden");
      roleLabel.textContent = role || "—";
    }

    document.getElementById("btnLogin").onclick = async () => {
      const email = (document.getElementById("loginEmail").value || "").trim();
      const pass  = (document.getElementById("loginPass").value || "").trim();
      document.getElementById("loginMsg").textContent = "";
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        showLoginUI("Identifiants invalides.");
      }
    };

    document.getElementById("btnLogout").onclick = async () => {
      try{ await auth.signOut(); }catch(e){}
      location.reload();
    };

    auth.onAuthStateChanged(async (user) => {
      if(!user){
        showLoginUI("");
        return;
      }

      try{
        role = await fetchRole(user.uid);
        if(role !== "gerant"){
          await auth.signOut();
          showLoginUI("Accès refusé : compte non gérant.");
          return;
        }
      }catch(e){
        try{ await auth.signOut(); }catch(_){}
        showLoginUI("Erreur d'accès.");
        return;
      }

      // ✅ Init dashboard après validation rôle gérant
      showAppUI();
      bootDashboard();
    });

    // ===== Boot dashboard =====
    function bootDashboard(){
      // date default
      dateInput.value = todayISO();
      dateInput.addEventListener('change', updateDashboard);

      // fill select
      fillEmpSelect();

      // first render
      updateDashboard();
    }

    function fillEmpSelect(){
      const sel = document.getElementById("empSelect");
      const list = equipe.slice().sort((a,b)=>{
        const A = a.nom+"_"+a.prenom, B = b.nom+"_"+b.prenom;
        if(A==="BOUCHNAK_NAOUAL") return -1;
        if(B==="BOUCHNAK_NAOUAL") return 1;
        return (a.nom+a.prenom).localeCompare(b.nom+b.prenom);
      });
      sel.innerHTML = list.map(e=>{
        const id = e.nom+"_"+e.prenom;
        return `<option value="${id}">${e.nom} ${e.prenom} — ${e.poste}</option>`;
      }).join("");
    }

    // ===== Mode switch =====
    function switchMode(mode, btn) {
      currentMode = mode;
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('chartContainer').classList.toggle('hidden', mode !== 'report');
      updateDashboard();
    }

    // ===== Main updater =====
    function updateDashboard() {
      if(role !== "gerant") return;

      if(activeDayListenerRef){
        activeDayListenerRef.off();
        activeDayListenerRef = null;
      }

      if(currentMode === 'report'){
        renderReportView();
        return;
      }

      activeDayListenerRef = database.ref('presences/' + dateInput.value);
      activeDayListenerRef.on('value', (snap) => {
        const data = snap.val() || {};
        renderDayView(data);
      });
    }

    // ===== Day view =====
    function renderDayView(data) {
      const container = document.getElementById('dashBody');
      const groups = {};
      equipe.forEach(e => (groups[e.poste] ||= []).push(e));

      let html = '';
      Object.keys(groups).forEach(poste => {
        html += `<div class="mb-8">
          <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 ml-1">${poste}</h3>
          <div class="grid grid-cols-2 gap-4">`;

        groups[poste].slice().sort((a,b)=>{
          const A = a.nom + '_' + a.prenom;
          const B = b.nom + '_' + b.prenom;
          if(A === "BOUCHNAK_NAOUAL") return -1;
          if(B === "BOUCHNAK_NAOUAL") return 1;
          return (a.nom+a.prenom).localeCompare(b.nom+b.prenom);
        }).forEach(emp => {
          const id = emp.nom + '_' + emp.prenom;
          const d = data[id] || {};

          const diff = getTimeDiff(d.hA, d.hP, id);
          const sClass = getStatusClass(diff, d.off, !!d.hA);

          let statusText = 'ATTENTE';
          let statusColor = 'text-slate-400';

          if(d.off){
            statusText = 'REPOS';
            statusColor = 'text-slate-400';
          } else if(d.hA){
            if(d.hP){
              statusText = diff > 0 ? `${diff}m retard` : `À L'HEURE`;
              statusColor = diff > 0 ? 'text-rose-600' : 'text-emerald-600';
            } else {
              statusText = `OK`;
              statusColor = 'text-emerald-600';
            }
          }

          html += `
            <button onclick="openHistory('${emp.nom}','${emp.prenom}')" class="staff-card ${sClass} glass-card p-4 rounded-2xl text-left flex flex-col justify-between h-28">
              <div>
                <p class="text-[11px] font-extrabold uppercase text-slate-800 truncate">${emp.nom}</p>
                <p class="text-[9px] font-medium text-slate-400">${emp.prenom}</p>
              </div>
              <p class="text-[10px] font-black ${statusColor}">${statusText}</p>
            </button>`;
        });

        html += `</div></div>`;
      });

      container.innerHTML = html;
    }

    // ===== Report view (mensuel) =====
    async function renderReportView() {
      const dates = getDatesInMonth(dateInput.value);

      const stats = {};
      equipe.forEach(e => {
        const id = e.nom+'_'+e.prenom;
        stats[id] = { info: e, present: 0, lateMin: 0, repos: 0, conge: 0, excluded: 0 };
      });

      const snaps = await Promise.all(dates.map(d => database.ref('presences/'+d).once('value')));

      const dailyLates = [], dailyPresence = [], labels = [];
      const today = todayISO();

      snaps.forEach((s, i) => {
        const dayISO = dates[i];
        labels.push(dayISO.split('-')[2]);

        // ✅ exclure jours futurs
        if(dayISO > today){
          dailyLates.push(0); dailyPresence.push(0);
          return;
        }

        // ✅ exclure plage Janvier 2026
        if(isExcluded(dayISO)){
          dailyLates.push(0); dailyPresence.push(0);
          Object.keys(stats).forEach(id => stats[id].excluded++);
          return;
        }

        const dData = s.val() || {};
        let tL = 0, tP = 0;

        if (!dData.disabled) {
          Object.keys(stats).forEach(id => {
            const e = dData[id] || null;

            // ✅ Pas de data => CONGÉ (uniquement jours passés / non exclus)
            if(!e){
              stats[id].conge++;
              return;
            }

            if(e.off){
              stats[id].repos++;
              return;
            }

            if(e.hA){
              const diff = getTimeDiff(e.hA, e.hP, id);
              stats[id].present++;
              stats[id].lateMin += diff;
              tL += diff; tP++;
              return;
            }

            stats[id].conge++;
          });
        }

        dailyLates.push(tL);
        dailyPresence.push(tP);
      });

      renderChart(labels, dailyLates, dailyPresence);

      const lateList = Object.values(stats).filter(s => s.lateMin > 0).sort((a,b) => b.lateMin - a.lateMin);
      const goodList = Object.values(stats).filter(s => s.lateMin === 0 && s.present > 0).sort((a,b) => b.present - a.present);

      let html = '<div class="space-y-8">';

      html += `<div>
        <h3 class="text-[10px] font-black text-rose-500 uppercase tracking-[0.2em] mb-4">Top Retardataires</h3>`;
      if(lateList.length === 0){
        html += `<div class="glass-card p-5 rounded-2xl text-center text-slate-400 font-extrabold text-[12px]">Aucun retard enregistré</div>`;
      }else{
        lateList.slice(0, 6).forEach(s => {
          html += `<div class="glass-card p-5 rounded-2xl mb-3 flex justify-between items-center">
            <span class="text-xs font-extrabold uppercase">${s.info.nom}</span>
            <span class="text-rose-600 font-black">${s.lateMin}m</span>
          </div>`;
        });
      }
      html += `</div>`;

      html += `<div>
        <h3 class="text-[10px] font-black text-emerald-500 uppercase tracking-[0.2em] mb-4">Les plus exemplaires</h3>`;
      if(goodList.length === 0){
        html += `<div class="glass-card p-5 rounded-2xl text-center text-slate-400 font-extrabold text-[12px]">Aucune présence "OK" trouvée</div>`;
      }else{
        goodList.slice(0, 6).forEach(s => {
          html += `<div class="glass-card p-5 rounded-2xl mb-3 flex justify-between items-center">
            <span class="text-xs font-extrabold uppercase">${s.info.nom}</span>
            <span class="text-emerald-600 font-black">${s.present}j OK</span>
          </div>`;
        });
      }
      html += '</div></div>';

      document.getElementById('dashBody').innerHTML = html;
    }

    // ✅ FIX: chart maintenant accepte 2 séries (retards + présences)
    function renderChart(labels, lates, presences) {
      const ctx = document.getElementById('trendsChart').getContext('2d');
      if (myChart) myChart.destroy();

      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: "Retards (min)",
              data: lates,
              borderColor: '#c5a059',
              tension: 0.35,
              borderWidth: 3,
              pointRadius: 0,
              fill: true,
              backgroundColor: 'rgba(197, 160, 89, 0.08)'
            },
            {
              label: "Présences (nb)",
              data: presences,
              borderColor: '#0f172a',
              tension: 0.35,
              borderWidth: 2,
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          },
          scales: {
            y: { display: false },
            x: { grid: { display: false }, ticks: { font: { size: 8 } } }
          }
        }
      });
    }

    function getDatesInMonth(seedISO) {
      const dates = [];
      const curr = new Date(seedISO);
      const m = curr.getMonth();
      const y = curr.getFullYear();
      const d = new Date(y, m, 1);
      while(d.getMonth() === m) {
        dates.push(d.toISOString().split('T')[0]);
        d.setDate(d.getDate()+1);
      }
      return dates;
    }

    function getDatesInYear(seedISO){
      const curr = new Date(seedISO);
      const y = curr.getFullYear();
      const dates = [];
      const d = new Date(y, 0, 1);
      while(d.getFullYear() === y){
        dates.push(d.toISOString().split('T')[0]);
        d.setDate(d.getDate()+1);
      }
      return dates;
    }

    // ===== Historique modal =====
    async function openHistory(nom, prenom) {
      const modal = document.getElementById('historyModal');
      document.getElementById('modalTitle').innerText = nom + " " + prenom;
      modal.classList.add('modal-active');

      const dates = getDatesInMonth(dateInput.value);
      const snaps = await Promise.all(dates.map(dt => database.ref('presences/'+dt).once('value')));

      const today = todayISO();
      let html = '';

      // reverse display
      const datesRev = dates.slice().reverse();
      const snapsRev = snaps.slice().reverse();

      snapsRev.forEach((s, i) => {
        const dayISO = datesRev[i];
        const data = s.val() || {};
        const id = nom+'_'+prenom;
        const entry = data[id] || null;

        let label = '';
        let cls = 'text-slate-400';

        if(dayISO > today){
          label = 'À venir'; cls = 'text-slate-300';
        } else if(isExcluded(dayISO)){
          label = 'Exclu'; cls = 'text-slate-400';
        } else if(!entry){
          label = 'Congé'; cls = 'text-slate-500';
        } else if(entry.off){
          label = 'Repos'; cls = 'text-slate-300';
        } else if(entry.hA){
          const diff = getTimeDiff(entry.hA, entry.hP, id);
          label = entry.hP ? (diff>0 ? `${diff}m` : 'OK') : 'OK';
          cls = diff>0 ? 'text-rose-500' : 'text-emerald-500';
        } else {
          label = 'Congé'; cls = 'text-slate-500';
        }

        html += `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100">
          <span class="text-[10px] font-black text-slate-400 uppercase">${fmtFR(dayISO)}</span>
          <span class="text-[10px] font-black ${cls} uppercase">${label}</span>
        </div>`;
      });

      document.getElementById('modalList').innerHTML = html || '<p class="text-center text-slate-300 py-10">Aucune donnée</p>';
    }

    function closeModal() {
      document.getElementById('historyModal').classList.remove('modal-active');
    }

    // ===== PDF helpers =====
    function showPDF(el){ el.style.display="block"; }
    function hidePDF(el){ el.style.display="none"; }

    function pdfHeader(title, sub){
      const date = dateInput.value;
      return `
        <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;">
          <div>
            <div style="font-weight:900;letter-spacing:.12em;color:#b0892f;font-size:10px;text-transform:uppercase;">Fès — Maroc</div>
            <div style="font-weight:900;font-size:20px;letter-spacing:-.02em;">GREY CORNER</div>
            <div style="font-weight:800;color:#374151;font-size:12px;margin-top:2px;">${title}</div>
            <div style="font-weight:700;color:#6b7280;font-size:10px;margin-top:2px;">${sub || ""}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900;color:#111827;font-size:12px;">Date : ${date}</div>
            <div style="font-weight:700;color:#6b7280;font-size:10px;">(Exclus: 01/01/2026 → 31/01/2026)</div>
          </div>
        </div>
        <hr style="margin:14px 0;border:none;border-top:1px solid #e5e7eb;" />
      `;
    }

    function kpiBox(t, v){
      return `<div class="pdfBox"><div class="t">${t}</div><div class="v">${v}</div></div>`;
    }

    async function downloadPDF_Day(){
      const dayISO = dateInput.value;

      const snap = await database.ref('presences/'+dayISO).once('value');
      const data = snap.val() || {};

      document.getElementById("pdfHeader").innerHTML = pdfHeader("Rapport Jour — Supervision", `Jour: ${fmtFR(dayISO)}`);

      let present=0, repos=0, attente=0;
      equipe.forEach(emp=>{
        const id = emp.nom+"_"+emp.prenom;
        const e = data[id] || null;
        if(e && e.off) repos++;
        else if(e && e.hA) present++;
        else attente++;
      });

      document.getElementById("pdfKpis").innerHTML = `
        <div class="pdfKpi">
          ${kpiBox("Total", equipe.length)}
          ${kpiBox("Présents", present)}
          ${kpiBox("Repos", repos)}
          ${kpiBox("Attente", attente)}
        </div>
      `;

      const rows = equipe.slice().sort((a,b)=>{
        const A=a.nom+"_"+a.prenom, B=b.nom+"_"+b.prenom;
        if(A==="BOUCHNAK_NAOUAL") return -1;
        if(B==="BOUCHNAK_NAOUAL") return 1;
        return (a.nom+a.prenom).localeCompare(b.nom+b.prenom);
      }).map(emp=>{
        const id = emp.nom+"_"+emp.prenom;
        const e = data[id] || null;

        let statut="ATTENTE", hp="", ha="", retard="";
        if(e){
          hp = e.hP || "";
          ha = e.hA || "";
          if(e.off){ statut="REPOS"; }
          else if(e.hA){
            statut="OK";
            if(e.hP){
              const diff = getTimeDiff(e.hA, e.hP, id);
              retard = diff>0 ? `+${diff}m` : "0";
              if(diff>0) statut="RETARD";
            }
          }else{
            statut="CONGÉ";
          }
        }else{
          statut="CONGÉ";
        }

        return `
          <tr>
            <td>${emp.nom} ${emp.prenom}</td>
            <td style="text-align:center;">${statut}</td>
            <td style="text-align:center;">${hp}</td>
            <td style="text-align:center;">${ha}</td>
            <td style="text-align:center;">${retard}</td>
          </tr>
        `;
      }).join("");

      document.getElementById("pdfContent").innerHTML = `
        <table class="pdfTable">
          <thead>
            <tr>
              <th style="text-align:left;">Employé</th>
              <th style="text-align:center;">Statut</th>
              <th style="text-align:center;">HP</th>
              <th style="text-align:center;">HA</th>
              <th style="text-align:center;">Retard</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const el = document.getElementById("pdfArea");
      showPDF(el);

      html2pdf().set({
        margin: 8,
        filename: `GC_RH_JOUR_${dayISO}.pdf`,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      }).from(el).save().then(()=>hidePDF(el)).catch(()=>hidePDF(el));
    }

    async function downloadPDF_EmployeeMonth(){
      const empId = document.getElementById("empSelect").value;
      const [nom, prenom] = empId.split("_");
      const seed = dateInput.value;
      const dates = getDatesInMonth(seed);
      const today = todayISO();

      const snaps = await Promise.all(dates.map(d => database.ref('presences/'+d).once('value')));

      let present=0, repos=0, conge=0, lateMin=0, excluded=0, ignoredFuture=0;

      const rows = dates.map((dayISO, i)=>{
        if(dayISO > today){
          ignoredFuture++;
          return `<tr><td>${fmtFR(dayISO)}</td><td>À venir</td><td></td><td></td><td></td></tr>`;
        }
        if(isExcluded(dayISO)){
          excluded++;
          return `<tr><td>${fmtFR(dayISO)}</td><td>Exclu</td><td></td><td></td><td></td></tr>`;
        }

        const data = snaps[i].val() || {};
        const e = data[empId] || null;

        if(!e){
          conge++;
          return `<tr><td>${fmtFR(dayISO)}</td><td>Congé</td><td></td><td></td><td></td></tr>`;
        }

        if(e.off){
          repos++;
          return `<tr><td>${fmtFR(dayISO)}</td><td>Repos</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td></td></tr>`;
        }

        if(e.hA){
          present++;
          const diff = getTimeDiff(e.hA, e.hP, empId);
          lateMin += diff;
          const st = (e.hP && diff>0) ? "Retard" : "OK";
          const r = (e.hP) ? (diff>0 ? `+${diff}m` : "0") : "";
          return `<tr><td>${fmtFR(dayISO)}</td><td>${st}</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td>${r}</td></tr>`;
        }

        conge++;
        return `<tr><td>${fmtFR(dayISO)}</td><td>Congé</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td></td></tr>`;
      }).join("");

      document.getElementById("pdfHeader").innerHTML =
        pdfHeader(`Rapport Mensuel — ${nom} ${prenom}`, `Mois: ${seed.slice(0,7)}`);

      document.getElementById("pdfKpis").innerHTML = `
        <div class="pdfKpi">
          ${kpiBox("Présents", present)}
          ${kpiBox("Repos", repos)}
          ${kpiBox("Congés", conge)}
          ${kpiBox("Retard (min)", lateMin)}
        </div>
        <div style="margin-top:8px;color:#6b7280;font-size:10px;font-weight:700;">
          Exclu: ${excluded} jour(s) • Jours futurs ignorés: ${ignoredFuture}
        </div>
      `;

      document.getElementById("pdfContent").innerHTML = `
        <table class="pdfTable">
          <thead>
            <tr>
              <th style="text-align:left;">Date</th>
              <th style="text-align:center;">Statut</th>
              <th style="text-align:center;">HP</th>
              <th style="text-align:center;">HA</th>
              <th style="text-align:center;">Retard</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const el = document.getElementById("pdfArea");
      showPDF(el);

      const file = `GC_RH_MOIS_${nom}_${prenom}_${seed.slice(0,7)}.pdf`;

      html2pdf().set({
        margin: 8,
        filename: file,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      }).from(el).save().then(()=>hidePDF(el)).catch(()=>hidePDF(el));
    }

    async function downloadPDF_EmployeeYear(){
      const empId = document.getElementById("empSelect").value;
      const [nom, prenom] = empId.split("_");
      const seed = dateInput.value;
      const year = seed.slice(0,4);

      const dates = getDatesInYear(seed);
      const today = todayISO();

      const snaps = await Promise.all(dates.map(d => database.ref('presences/'+d).once('value')));

      let present=0, repos=0, conge=0, lateMin=0, excluded=0, ignoredFuture=0;

      const rows = dates.map((dayISO, i)=>{
        if(dayISO > today){ ignoredFuture++; return ''; }
        if(isExcluded(dayISO)){ excluded++; return ''; }

        const data = snaps[i].val() || {};
        const e = data[empId] || null;

        if(!e){
          conge++;
          return `<tr><td>${fmtFR(dayISO)}</td><td>Congé</td><td></td><td></td><td></td></tr>`;
        }

        if(e.off){
          repos++;
          return `<tr><td>${fmtFR(dayISO)}</td><td>Repos</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td></td></tr>`;
        }

        if(e.hA){
          present++;
          const diff = getTimeDiff(e.hA, e.hP, empId);
          lateMin += diff;
          const st = (e.hP && diff>0) ? "Retard" : "OK";
          const r = (e.hP) ? (diff>0 ? `+${diff}m` : "0") : "";
          return `<tr><td>${fmtFR(dayISO)}</td><td>${st}</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td>${r}</td></tr>`;
        }

        conge++;
        return `<tr><td>${fmtFR(dayISO)}</td><td>Congé</td><td>${e.hP||""}</td><td>${e.hA||""}</td><td></td></tr>`;
      }).join("");

      document.getElementById("pdfHeader").innerHTML =
        pdfHeader(`Rapport Annuel — ${nom} ${prenom}`, `Année: ${year}`);

      document.getElementById("pdfKpis").innerHTML = `
        <div class="pdfKpi">
          ${kpiBox("Présents", present)}
          ${kpiBox("Repos", repos)}
          ${kpiBox("Congés", conge)}
          ${kpiBox("Retard (min)", lateMin)}
        </div>
        <div style="margin-top:8px;color:#6b7280;font-size:10px;font-weight:700;">
          Exclu (01/01/2026 → 31/01/2026): ${excluded} jour(s) ignorés • Jours futurs ignorés: ${ignoredFuture}
        </div>
      `;

      document.getElementById("pdfContent").innerHTML = `
        <table class="pdfTable">
          <thead>
            <tr>
              <th style="text-align:left;">Date</th>
              <th style="text-align:center;">Statut</th>
              <th style="text-align:center;">HP</th>
              <th style="text-align:center;">HA</th>
              <th style="text-align:center;">Retard</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const el = document.getElementById("pdfArea");
      showPDF(el);

      const file = `GC_RH_ANNEE_${nom}_${prenom}_${year}.pdf`;

      html2pdf().set({
        margin: 8,
        filename: file,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      }).from(el).save().then(()=>hidePDF(el)).catch(()=>hidePDF(el));
    }
  </script>
</body>
</html>